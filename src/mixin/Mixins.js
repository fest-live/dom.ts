import { observeAttributeBySelector, observeBySelector } from "./Observer";
import { getStoresOfElement, namedStoreMaps } from "./Store";
import { boundBehaviors } from "./Behavior";
// mixin { connect: (element, { ... })=>{},  disconnect: (element, { ... }): ()=>{}}
export const reflectMixins = (element, mixins) => {
    if (!element)
        return;
    if (mixins) {
        const mixinSet = boundMixinSet?.get?.(element) ?? new WeakSet();
        if (!boundMixinSet?.has?.(element)) {
            boundMixinSet?.set?.(element, mixinSet);
        }
        [...(mixins?.values?.() || [])].map((e) => bindMixins(element, e, mixinSet));
    }
    return element;
};
//
export const getElementRelated = (element) => {
    return {
        storeSet: getStoresOfElement(namedStoreMaps, element),
        mixinSet: boundMixinSet?.get?.(element),
        behaviorSet: boundBehaviors?.get?.(element)
    };
};
//
export const bindMixins = (element, mixin, mixSet) => {
    const wel = new WeakRef(element);
    mixSet ||= boundMixinSet?.get?.(element);
    if (!mixSet?.has?.(mixin)) {
        mixSet?.add?.(mixin);
        mixinElements?.get?.(mixin)?.add?.(element);
        if (mixin.name) {
            element?.setAttribute?.("data-mixin", [...(element?.getAttribute?.("data-mixin")?.split?.(" ") || []), mixin.name].filter((n) => !!n).join(" "));
        }
        mixin?.connect?.(wel, mixin, getElementRelated(element));
    }
    return element;
};
// element <--> mixin-set
export const boundMixinSet = new WeakMap();
export const mixinElements = new WeakMap();
// mixin-set <--> naming
export const mixinRegistry = new Map();
export const mixinNamespace = new WeakMap;
//
export const updateMixinAttributes = (element, mixin) => {
    if (typeof mixin == "string") {
        mixin = mixinRegistry?.get?.(mixin);
    }
    const names = new Set([...(element?.getAttribute?.("data-mixin")?.split?.(" ") || [])]);
    const mixins = new Set([...names].map((n) => mixinRegistry?.get?.(n)).filter((m) => !!m));
    const mixinSet = boundMixinSet?.get?.(element) ?? new WeakSet();
    //
    if (!mixinElements?.has?.(mixin)) {
        mixinElements?.set?.(mixin, new WeakSet());
    }
    if (!boundMixinSet?.has?.(element)) {
        boundMixinSet?.set?.(element, mixinSet);
    }
    //
    const wel = new WeakRef(element);
    if (!mixinSet?.has?.(mixin)) {
        if (!mixins.has(mixin)) {
            mixin?.disconnect?.(wel, mixin, getElementRelated(element));
        }
        if (mixins.has(mixin) || !mixinElements?.get?.(mixin)?.has?.(element)) {
            mixin?.connect?.(wel, mixin, getElementRelated(element));
            names.add(mixinNamespace?.get?.(mixin));
            mixinSet?.add?.(mixin);
            element?.setAttribute?.("data-mixin", [...names].filter((n) => !!n).join(" "));
        }
        mixinElements?.get?.(mixin)?.add?.(element);
    }
    if (mixinSet?.has?.(mixin)) {
        if (!mixins.has(mixin)) {
            mixinSet?.delete?.(mixin);
            mixin?.disconnect?.(wel, mixin, getElementRelated(element));
        }
    }
};
//
export const roots = new Set();
export const addRoot = (root = typeof document != "undefined" ? document : null) => {
    if (!root)
        return;
    if (!roots?.has?.(root)) {
        roots?.add?.(root);
        // as attribute (reacts on attribute changes)
        observeAttributeBySelector(root, "*", "data-mixin", (mutation) => updateAllMixins(mutation.target));
        // as DOM nodes (reacts on DOM changes)
        observeBySelector(root, "[data-mixin]", (mutation) => {
            for (const element of mutation.addedNodes) {
                if (element instanceof HTMLElement) {
                    updateAllMixins(element);
                }
            }
        });
    }
    return root;
};
//
export const updateAllMixins = (element) => {
    const names = new Set([...(element?.getAttribute?.("data-mixin")?.split?.(" ") || [])]);
    const mixins = new Set([...names].map((n) => mixinRegistry?.get?.(n)).filter((m) => !!m));
    [...mixins]?.map?.((m) => updateMixinAttributes(element, m));
};
//
export const updateMixinAttributesAll = (elements, mixin) => { elements.forEach((e) => (mixin ? updateMixinAttributes(e, mixin) : updateAllMixins(e))); };
export const updateMixinAttributesAllInRoots = (mixin) => {
    for (const root of roots) {
        updateMixinAttributesAll(root?.querySelectorAll?.("[data-mixin]"), mixin);
    }
};
//
export const nameRegistryF = new FinalizationRegistry((key) => { mixinRegistry?.delete?.(key); });
export const registerMixin = (name, mixin) => {
    if (!mixinNamespace?.has?.(mixin)) {
        const key = name?.trim?.();
        if (key) {
            mixinNamespace?.set?.(mixin, key);
            mixinRegistry?.set?.(key, mixin);
            nameRegistryF?.register?.(mixin, key);
            updateMixinAttributesAllInRoots(mixin);
        }
    }
};
//
addRoot(typeof document != "undefined" ? document : null);
//
export class DOMMixin {
    constructor(name = null) { if (name) {
        registerMixin(name, this);
    } }
    //
    connect(wElement, wSelf, related) { return this; }
    disconnect(wElement, wSelf, related) { return this; }
    //
    storeForElement(element) { return namedStoreMaps.get(this.name || "")?.get?.(element); }
    ;
    relatedForElement(element) { return getElementRelated(element); }
    //
    get elements() { return mixinElements?.get?.(this); }
    get storage() { return namedStoreMaps?.get?.(this.name || ""); }
    get name() { return mixinNamespace?.get?.(this); }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWl4aW5zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTWl4aW5zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUMzRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsY0FBYyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzdELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFFNUMsb0ZBQW9GO0FBQ3BGLE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUMsRUFBRTtJQUM1QyxJQUFJLENBQUMsT0FBTztRQUFFLE9BQU87SUFDckIsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUNULE1BQU0sUUFBUSxHQUFHLGFBQWEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ2hFLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFBQyxDQUFDO1FBQ2hGLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQSxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFDRCxPQUFPLE9BQU8sQ0FBQztBQUNuQixDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxPQUFPLEVBQUMsRUFBRTtJQUN4QyxPQUFPO1FBQ0gsUUFBUSxFQUFFLGtCQUFrQixDQUFDLGNBQWMsRUFBRSxPQUFPLENB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cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgb2JzZXJ2ZUF0dHJpYnV0ZUJ5U2VsZWN0b3IsIG9ic2VydmVCeVNlbGVjdG9yIH0gZnJvbSBcIi4vT2JzZXJ2ZXJcIjtcbmltcG9ydCB7IGdldFN0b3Jlc09mRWxlbWVudCwgbmFtZWRTdG9yZU1hcHMgfSBmcm9tIFwiLi9TdG9yZVwiO1xuaW1wb3J0IHsgYm91bmRCZWhhdmlvcnMgfSBmcm9tIFwiLi9CZWhhdmlvclwiO1xuXG4vLyBtaXhpbiB7IGNvbm5lY3Q6IChlbGVtZW50LCB7IC4uLiB9KT0+e30sICBkaXNjb25uZWN0OiAoZWxlbWVudCwgeyAuLi4gfSk6ICgpPT57fX1cbmV4cG9ydCBjb25zdCByZWZsZWN0TWl4aW5zID0gKGVsZW1lbnQsIG1peGlucyk9PntcbiAgICBpZiAoIWVsZW1lbnQpIHJldHVybjtcbiAgICBpZiAobWl4aW5zKSB7XG4gICAgICAgIGNvbnN0IG1peGluU2V0ID0gYm91bmRNaXhpblNldD8uZ2V0Py4oZWxlbWVudCkgPz8gbmV3IFdlYWtTZXQoKTtcbiAgICAgICAgaWYgKCFib3VuZE1peGluU2V0Py5oYXM/LihlbGVtZW50KSkgeyBib3VuZE1peGluU2V0Py5zZXQ/LihlbGVtZW50LCBtaXhpblNldCk7IH1cbiAgICAgICAgWy4uLihtaXhpbnM/LnZhbHVlcz8uKCkgfHwgW10pXS5tYXAoKGUpPT5iaW5kTWl4aW5zKGVsZW1lbnQsIGUsIG1peGluU2V0KSk7XG4gICAgfVxuICAgIHJldHVybiBlbGVtZW50O1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGdldEVsZW1lbnRSZWxhdGVkID0gKGVsZW1lbnQpPT57XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc3RvcmVTZXQ6IGdldFN0b3Jlc09mRWxlbWVudChuYW1lZFN0b3JlTWFwcywgZWxlbWVudCksXG4gICAgICAgIG1peGluU2V0OiBib3VuZE1peGluU2V0Py5nZXQ/LihlbGVtZW50KSxcbiAgICAgICAgYmVoYXZpb3JTZXQ6IGJvdW5kQmVoYXZpb3JzPy5nZXQ/LihlbGVtZW50KVxuICAgIH1cbn1cblxuLy9cbmV4cG9ydCBjb25zdCBiaW5kTWl4aW5zID0gKGVsZW1lbnQsIG1peGluLCBtaXhTZXQ/KT0+e1xuICAgIGNvbnN0IHdlbCA9IG5ldyBXZWFrUmVmKGVsZW1lbnQpOyBtaXhTZXQgfHw9IGJvdW5kTWl4aW5TZXQ/LmdldD8uKGVsZW1lbnQpO1xuICAgIGlmICghbWl4U2V0Py5oYXM/LihtaXhpbikpIHsgbWl4U2V0Py5hZGQ/LihtaXhpbik7IG1peGluRWxlbWVudHM/LmdldD8uKG1peGluKT8uYWRkPy4oZWxlbWVudCk7XG4gICAgICAgIGlmIChtaXhpbi5uYW1lKSB7IGVsZW1lbnQ/LnNldEF0dHJpYnV0ZT8uKFwiZGF0YS1taXhpblwiLCBbLi4uKGVsZW1lbnQ/LmdldEF0dHJpYnV0ZT8uKFwiZGF0YS1taXhpblwiKT8uc3BsaXQ/LihcIiBcIikgfHwgW10pLCBtaXhpbi5uYW1lXS5maWx0ZXIoKG4pPT4hIW4pLmpvaW4oXCIgXCIpKTsgfVxuICAgICAgICBtaXhpbj8uY29ubmVjdD8uKHdlbCwgbWl4aW4sIGdldEVsZW1lbnRSZWxhdGVkKGVsZW1lbnQpKTtcbiAgICB9XG4gICAgcmV0dXJuIGVsZW1lbnQ7XG59XG5cbi8vIGVsZW1lbnQgPC0tPiBtaXhpbi1zZXRcbmV4cG9ydCBjb25zdCBib3VuZE1peGluU2V0ICA9IG5ldyBXZWFrTWFwPGFueSwgV2Vha1NldDxhbnk+PigpO1xuZXhwb3J0IGNvbnN0IG1peGluRWxlbWVudHMgID0gbmV3IFdlYWtNYXA8YW55LCBhbnk+KCk7XG5cbi8vIG1peGluLXNldCA8LS0+IG5hbWluZ1xuZXhwb3J0IGNvbnN0IG1peGluUmVnaXN0cnkgID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcbmV4cG9ydCBjb25zdCBtaXhpbk5hbWVzcGFjZSA9IG5ldyBXZWFrTWFwPGFueSwgc3RyaW5nPjtcblxuLy9cbmV4cG9ydCBjb25zdCB1cGRhdGVNaXhpbkF0dHJpYnV0ZXMgPSAoZWxlbWVudCwgbWl4aW4pPT57XG4gICAgaWYgKHR5cGVvZiBtaXhpbiA9PSBcInN0cmluZ1wiKSB7IG1peGluID0gbWl4aW5SZWdpc3RyeT8uZ2V0Py4obWl4aW4pOyB9XG4gICAgY29uc3QgbmFtZXMgID0gbmV3IFNldChbLi4uKGVsZW1lbnQ/LmdldEF0dHJpYnV0ZT8uKFwiZGF0YS1taXhpblwiKT8uc3BsaXQ/LihcIiBcIikgfHwgW10pXSk7XG4gICAgY29uc3QgbWl4aW5zID0gbmV3IFNldChbLi4ubmFtZXNdLm1hcCgobik9Pm1peGluUmVnaXN0cnk/LmdldD8uKG4pKS5maWx0ZXIoKG0pPT4hIW0pKTtcbiAgICBjb25zdCBtaXhpblNldCA9IGJvdW5kTWl4aW5TZXQ/LmdldD8uKGVsZW1lbnQpID8/IG5ldyBXZWFrU2V0KCk7XG5cbiAgICAvL1xuICAgIGlmICghbWl4aW5FbGVtZW50cz8uaGFzPy4obWl4aW4pKSB7IG1peGluRWxlbWVudHM/LnNldD8uKG1peGluLCBuZXcgV2Vha1NldCgpKTsgfVxuICAgIGlmICghYm91bmRNaXhpblNldD8uaGFzPy4oZWxlbWVudCkpIHsgYm91bmRNaXhpblNldD8uc2V0Py4oZWxlbWVudCwgbWl4aW5TZXQpOyB9XG5cbiAgICAvL1xuICAgIGNvbnN0IHdlbCA9IG5ldyBXZWFrUmVmKGVsZW1lbnQpO1xuICAgIGlmICghbWl4aW5TZXQ/Lmhhcz8uKG1peGluKSkge1xuICAgICAgICBpZiAoIW1peGlucy5oYXMobWl4aW4pKSB7IG1peGluPy5kaXNjb25uZWN0Py4od2VsLCBtaXhpbiwgZ2V0RWxlbWVudFJlbGF0ZWQoZWxlbWVudCkpOyB9XG4gICAgICAgIGlmICggbWl4aW5zLmhhcyhtaXhpbikgfHwgIW1peGluRWxlbWVudHM/LmdldD8uKG1peGluKT8uaGFzPy4oZWxlbWVudCkpIHsgbWl4aW4/LmNvbm5lY3Q/Lih3ZWwsIG1peGluLCBnZXRFbGVtZW50UmVsYXRlZChlbGVtZW50KSk7XG4gICAgICAgICAgICBuYW1lcy5hZGQobWl4aW5OYW1lc3BhY2U/LmdldD8uKG1peGluKSk7IG1peGluU2V0Py5hZGQ/LihtaXhpbik7XG4gICAgICAgICAgICBlbGVtZW50Py5zZXRBdHRyaWJ1dGU/LihcImRhdGEtbWl4aW5cIiwgWy4uLm5hbWVzXS5maWx0ZXIoKG4pPT4hIW4pLmpvaW4oXCIgXCIpKTtcbiAgICAgICAgfVxuICAgICAgICBtaXhpbkVsZW1lbnRzPy5nZXQ/LihtaXhpbik/LmFkZD8uKGVsZW1lbnQpO1xuICAgIH1cbiAgICBpZiAobWl4aW5TZXQ/Lmhhcz8uKG1peGluKSkge1xuICAgICAgICBpZiAoIW1peGlucy5oYXMobWl4aW4pKSB7IG1peGluU2V0Py5kZWxldGU/LihtaXhpbik7IG1peGluPy5kaXNjb25uZWN0Py4od2VsLCBtaXhpbiwgZ2V0RWxlbWVudFJlbGF0ZWQoZWxlbWVudCkpOyB9XG4gICAgfVxufVxuXG4vL1xuZXhwb3J0IGNvbnN0IHJvb3RzICAgPSBuZXcgU2V0PGFueT4oKTtcbmV4cG9ydCBjb25zdCBhZGRSb290ID0gKHJvb3Q6IGFueSA9IHR5cGVvZiBkb2N1bWVudCAhPSBcInVuZGVmaW5lZFwiID8gZG9jdW1lbnQgOiBudWxsKSA9PiB7XG4gICAgaWYgKCFyb290KSByZXR1cm47XG4gICAgaWYgKCFyb290cz8uaGFzPy4ocm9vdCkpIHtcbiAgICAgICAgcm9vdHM/LmFkZD8uKHJvb3QpO1xuXG4gICAgICAgIC8vIGFzIGF0dHJpYnV0ZSAocmVhY3RzIG9uIGF0dHJpYnV0ZSBjaGFuZ2VzKVxuICAgICAgICBvYnNlcnZlQXR0cmlidXRlQnlTZWxlY3Rvcihyb290LCBcIipcIiwgXCJkYXRhLW1peGluXCIsIChtdXRhdGlvbikgPT4gdXBkYXRlQWxsTWl4aW5zKG11dGF0aW9uLnRhcmdldCkpO1xuXG4gICAgICAgIC8vIGFzIERPTSBub2RlcyAocmVhY3RzIG9uIERPTSBjaGFuZ2VzKVxuICAgICAgICBvYnNlcnZlQnlTZWxlY3Rvcihyb290LCBcIltkYXRhLW1peGluXVwiLCAobXV0YXRpb24pID0+IHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiBtdXRhdGlvbi5hZGRlZE5vZGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVBbGxNaXhpbnMoZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJvb3Q7XG59O1xuXG4vL1xuZXhwb3J0IGNvbnN0IHVwZGF0ZUFsbE1peGlucyA9IChlbGVtZW50KT0+e1xuICAgIGNvbnN0IG5hbWVzICA9IG5ldyBTZXQoWy4uLihlbGVtZW50Py5nZXRBdHRyaWJ1dGU/LihcImRhdGEtbWl4aW5cIik/LnNwbGl0Py4oXCIgXCIpIHx8IFtdKV0pO1xuICAgIGNvbnN0IG1peGlucyA9IG5ldyBTZXQoWy4uLm5hbWVzXS5tYXAoKG4pPT5taXhpblJlZ2lzdHJ5Py5nZXQ/LihuKSkuZmlsdGVyKChtKT0+ISFtKSk7XG4gICAgWy4uLm1peGluc10/Lm1hcD8uKChtKT0+dXBkYXRlTWl4aW5BdHRyaWJ1dGVzKGVsZW1lbnQsIG0pKTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCB1cGRhdGVNaXhpbkF0dHJpYnV0ZXNBbGwgPSAoZWxlbWVudHMsIG1peGluKT0+eyBlbGVtZW50cy5mb3JFYWNoKChlKT0+KG1peGluID8gdXBkYXRlTWl4aW5BdHRyaWJ1dGVzKGUsIG1peGluKSA6IHVwZGF0ZUFsbE1peGlucyhlKSkpIH1cbmV4cG9ydCBjb25zdCB1cGRhdGVNaXhpbkF0dHJpYnV0ZXNBbGxJblJvb3RzID0gKG1peGluKSA9PiB7XG4gICAgZm9yIChjb25zdCByb290IG9mIHJvb3RzKSB7IHVwZGF0ZU1peGluQXR0cmlidXRlc0FsbChyb290Py5xdWVyeVNlbGVjdG9yQWxsPy4oXCJbZGF0YS1taXhpbl1cIiksIG1peGluKTsgfVxufVxuXG4vL1xuZXhwb3J0IGNvbnN0IG5hbWVSZWdpc3RyeUYgPSBuZXcgRmluYWxpemF0aW9uUmVnaXN0cnkoKGtleTogYW55KT0+eyBtaXhpblJlZ2lzdHJ5Py5kZWxldGU/LihrZXkpOyB9KTtcbmV4cG9ydCBjb25zdCByZWdpc3Rlck1peGluID0gKG5hbWUsIG1peGluKSA9PiB7XG4gICAgaWYgKCFtaXhpbk5hbWVzcGFjZT8uaGFzPy4obWl4aW4pKSB7XG4gICAgICAgIGNvbnN0IGtleSA9IG5hbWU/LnRyaW0/LigpO1xuICAgICAgICBpZiAoa2V5KSB7XG4gICAgICAgICAgICBtaXhpbk5hbWVzcGFjZT8uc2V0Py4obWl4aW4sIGtleSk7XG4gICAgICAgICAgICBtaXhpblJlZ2lzdHJ5Py5zZXQ/LihrZXksIG1peGluKTtcbiAgICAgICAgICAgIG5hbWVSZWdpc3RyeUY/LnJlZ2lzdGVyPy4obWl4aW4sIGtleSk7XG4gICAgICAgICAgICB1cGRhdGVNaXhpbkF0dHJpYnV0ZXNBbGxJblJvb3RzKG1peGluKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbi8vXG5hZGRSb290KHR5cGVvZiBkb2N1bWVudCAhPSBcInVuZGVmaW5lZFwiID8gZG9jdW1lbnQgOiBudWxsKTtcblxuLy9cbmV4cG9ydCBjbGFzcyBET01NaXhpbiB7XG4gICAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nfG51bGwgPSBudWxsKSB7IGlmIChuYW1lKSB7IHJlZ2lzdGVyTWl4aW4obmFtZSwgdGhpcyk7IH0gfVxuXG4gICAgLy9cbiAgICBwdWJsaWMgY29ubmVjdCh3RWxlbWVudCwgd1NlbGYsIHJlbGF0ZWQpIHsgcmV0dXJuIHRoaXM7IH1cbiAgICBwdWJsaWMgZGlzY29ubmVjdCh3RWxlbWVudCwgd1NlbGYsIHJlbGF0ZWQpIHsgcmV0dXJuIHRoaXM7IH1cblxuICAgIC8vXG4gICAgcHVibGljIHN0b3JlRm9yRWxlbWVudChlbGVtZW50KSB7IHJldHVybiBuYW1lZFN0b3JlTWFwcy5nZXQodGhpcy5uYW1lIHx8IFwiXCIpPy5nZXQ/LihlbGVtZW50KTsgfTtcbiAgICBwdWJsaWMgcmVsYXRlZEZvckVsZW1lbnQoZWxlbWVudCkgeyByZXR1cm4gZ2V0RWxlbWVudFJlbGF0ZWQoZWxlbWVudCk7IH1cblxuICAgIC8vXG4gICAgZ2V0IGVsZW1lbnRzKCkgeyByZXR1cm4gbWl4aW5FbGVtZW50cz8uZ2V0Py4odGhpcyk7IH1cbiAgICBnZXQgc3RvcmFnZSgpIHsgcmV0dXJuIG5hbWVkU3RvcmVNYXBzPy5nZXQ/Lih0aGlzLm5hbWUgfHwgXCJcIik7IH1cbiAgICBnZXQgbmFtZSgpIHsgcmV0dXJuIG1peGluTmFtZXNwYWNlPy5nZXQ/Lih0aGlzKTsgfVxufVxuIl19