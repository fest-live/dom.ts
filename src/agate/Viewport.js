import { addEvent } from "./Utils";
//
export const getAvailSize = () => {
    const l = typeof matchMedia != "undefined" ? matchMedia("(orientation: landscape)")?.matches : false;
    if (typeof screen != "undefined") {
        const aw = screen?.availWidth + "px";
        const ah = screen?.availHeight + "px";
        return {
            "--screen-width": Math.min(screen?.width, screen?.availWidth) + "px",
            "--screen-height": Math.min(screen?.height, screen?.availHeight) + "px",
            "--avail-width": l ? ah : aw,
            "--avail-height": l ? aw : ah,
            "--view-height": (Math.min(screen?.availHeight, window?.innerHeight) + "px"),
            "--pixel-ratio": devicePixelRatio || 1,
        };
    }
    ;
    return {
        "--screen-width": 0 + "px",
        "--screen-height": 0 + "px",
        "--avail-width": 0 + "px",
        "--avail-height": 0 + "px",
        "--view-height": 0 + "px",
        "--pixel-ratio": 1,
    };
};
//
export const availSize = getAvailSize();
export const classes = [[":root, :host, :scope", availSize]];
export const orientationNumberMap = {
    "portrait-primary": 0, // as 0deg, aka. 360deg
    "landscape-primary": 1, // as -90deg, aka. 270deg
    "portrait-secondary": 2, // as -180deg, aka. 180deg
    "landscape-secondary": 3 // as -270deg, aka. 90deg
};
//
export const updateVP = (ev) => {
    const rule = document.documentElement;
    Object.assign(availSize, getAvailSize());
    Object.entries(availSize).forEach(([propName, propValue]) => {
        const exists = rule?.style?.getPropertyValue(propName);
        if (!exists || exists != propValue) {
            rule?.style?.setProperty?.(propName, (propValue || ""), "");
        }
    });
    // make secondary screen orientation detectable
    document.documentElement.style.setProperty("--orientation-secondary", screen?.orientation?.type?.endsWith?.("secondary") ? "1" : "0");
};
//
export const getCorrectOrientation = () => {
    let orientationType = screen.orientation.type;
    if (!globalThis.matchMedia("((display-mode: fullscreen) or (display-mode: standalone) or (display-mode: window-controls-overlay))").matches) {
        if (matchMedia("(orientation: portrait)").matches) {
            orientationType = orientationType.replace("landscape", "portrait");
        }
        else if (matchMedia("(orientation: landscape)").matches) {
            orientationType = orientationType.replace("portrait", "landscape");
        }
        ;
    }
    return orientationType;
};
//
const passiveOpts = { passive: true };
//
export const whenAnyScreenChanges = (cb) => {
    let ticking = false;
    const update = () => {
        if (!ticking) {
            requestAnimationFrame(() => {
                cb();
                ticking = false;
            });
            ticking = true;
        }
    };
    const unsubscribers = [];
    // @ts-ignore
    unsubscribers.push(addEvent(navigator?.virtualKeyboard, "geometrychange", update, passiveOpts));
    unsubscribers.push(addEvent(window?.visualViewport, "scroll", update, passiveOpts));
    unsubscribers.push(addEvent(window?.visualViewport, "resize", update, passiveOpts));
    unsubscribers.push(addEvent(screen?.orientation, "change", update));
    unsubscribers.push(addEvent(window, "resize", update));
    unsubscribers.push(addEvent(document?.documentElement, "fullscreenchange", update));
    unsubscribers.push(addEvent(document, "DOMContentLoaded", update));
    unsubscribers.push(addEvent(matchMedia("(orientation: portrait)"), "change", update));
    //
    update();
    requestIdleCallback(update, { timeout: 100 });
    return () => unsubscribers.forEach((unsub) => unsub());
};
//
export const fixOrientToScreen = (element) => {
    if (!element?.classList?.contains?.("native-portrait-optimized")) {
        element?.classList?.add?.("native-portrait-optimized");
        return whenAnyScreenChanges(() => {
            element.orient = orientationNumberMap?.[getCorrectOrientation()] || 0;
        });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVmlld3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJWaWV3cG9ydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRW5DLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsR0FBRyxFQUFFO0lBQzdCLE1BQU0sQ0FBQyxHQUFHLE9BQU8sVUFBVSxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLDBCQUEwQixDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7SUFDckcsSUFBSSxPQUFPLE1BQU0sSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUMvQixNQUFNLEVBQUUsR0FBRyxNQUFNLEVBQUUsVUFBVSxHQUFHLElBQUksQ0FBQztRQUNyQyxNQUFNLEVBQUUsR0FBRyxNQUFNLEVBQUUsV0FBVyxHQUFHLElBQUksQ0FBQztRQUN0QyxPQUFPO1lBQ0gsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxVQUFVLENBQUMsR0FBRyxJQUFJO1lBQ3BFLGlCQUFpQixFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLEdBQUcsSUFBSTtZQUN2RSxlQUFlLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDNUIsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDN0IsZUFBZSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxXQUFXLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDNUUsZUFBZSxFQUFFLGdCQUFnQixJQUFJLENBQUM7U0FDekMsQ0FBQztJQUNO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LEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNuRSxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMseUJBQXlCLENBQUMsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUV0RixFQUFFO0lBQ0YsTUFBTSxFQUFFLENBQUM7SUFDVCxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUM5QyxPQUFPLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7QUFDM0QsQ0FBQyxDQUFDO0FBRUYsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLENBQUMsT0FBTyxFQUFDLEVBQUU7SUFDeEMsSUFBSSxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLENBQUMsMkJBQTJCLENBQUMsRUFBRSxDQUFDO1FBQy9ELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLENBQUMsMkJBQTJCLENBQUMsQ0FBQztRQUN2RCxPQUFPLG9CQUFvQixDQUFDLEdBQUUsRUFBRTtZQUM1QixPQUFPLENBQUMsTUFBTSxHQUFHLG9CQUFvQixFQUFFLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxRSxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7QUFDTCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFN0eWxlVHVwbGUgfSBmcm9tIFwiLi4vbWl4aW4vU3R5bGVcIjtcbmltcG9ydCB7IGFkZEV2ZW50IH0gZnJvbSBcIi4vVXRpbHNcIjtcblxuLy9cbmV4cG9ydCBjb25zdCBnZXRBdmFpbFNpemUgPSAoKSA9PiB7XG4gICAgY29uc3QgbCA9IHR5cGVvZiBtYXRjaE1lZGlhICE9IFwidW5kZWZpbmVkXCIgPyBtYXRjaE1lZGlhKFwiKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpXCIpPy5tYXRjaGVzIDogZmFsc2U7XG4gICAgaWYgKHR5cGVvZiBzY3JlZW4gIT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICBjb25zdCBhdyA9IHNjcmVlbj8uYXZhaWxXaWR0aCArIFwicHhcIjtcbiAgICAgICAgY29uc3QgYWggPSBzY3JlZW4/LmF2YWlsSGVpZ2h0ICsgXCJweFwiO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgXCItLXNjcmVlbi13aWR0aFwiOiBNYXRoLm1pbihzY3JlZW4/LndpZHRoLCBzY3JlZW4/LmF2YWlsV2lkdGgpICsgXCJweFwiLFxuICAgICAgICAgICAgXCItLXNjcmVlbi1oZWlnaHRcIjogTWF0aC5taW4oc2NyZWVuPy5oZWlnaHQsIHNjcmVlbj8uYXZhaWxIZWlnaHQpICsgXCJweFwiLFxuICAgICAgICAgICAgXCItLWF2YWlsLXdpZHRoXCI6IGwgPyBhaCA6IGF3LFxuICAgICAgICAgICAgXCItLWF2YWlsLWhlaWdodFwiOiBsID8gYXcgOiBhaCxcbiAgICAgICAgICAgIFwiLS12aWV3LWhlaWdodFwiOiAoTWF0aC5taW4oc2NyZWVuPy5hdmFpbEhlaWdodCwgd2luZG93Py5pbm5lckhlaWdodCkgKyBcInB4XCIpLFxuICAgICAgICAgICAgXCItLXBpeGVsLXJhdGlvXCI6IGRldmljZVBpeGVsUmF0aW8gfHwgMSxcbiAgICAgICAgfTtcbiAgICB9O1xuICAgIHJldHVybiB7XG4gICAgICAgIFwiLS1zY3JlZW4td2lkdGhcIjogMCArIFwicHhcIixcbiAgICAgICAgXCItLXNjcmVlbi1oZWlnaHRcIjogMCArIFwicHhcIixcbiAgICAgICAgXCItLWF2YWlsLXdpZHRoXCI6IDAgKyBcInB4XCIsXG4gICAgICAgIFwiLS1hdmFpbC1oZWlnaHRcIjogMCArIFwicHhcIixcbiAgICAgICAgXCItLXZpZXctaGVpZ2h0XCI6IDAgKyBcInB4XCIsXG4gICAgICAgIFwiLS1waXhlbC1yYXRpb1wiOiAxLFxuICAgIH07XG59XG5cbi8vXG5leHBvcnQgY29uc3QgYXZhaWxTaXplID0gZ2V0QXZhaWxTaXplKCk7XG5leHBvcnQgY29uc3QgY2xhc3NlczogU3R5bGVUdXBsZVtdID0gWyBbXCI6cm9vdCwgOmhvc3QsIDpzY29wZVwiLCBhdmFpbFNpemVdIF07XG5leHBvcnQgY29uc3Qgb3JpZW50YXRpb25OdW1iZXJNYXAgPSB7XG4gICAgXCJwb3J0cmFpdC1wcmltYXJ5XCI6IDAsIC8vIGFzIDBkZWcsIGFrYS4gMzYwZGVnXG4gICAgXCJsYW5kc2NhcGUtcHJpbWFyeVwiOiAxLCAvLyBhcyAtOTBkZWcsIGFrYS4gMjcwZGVnXG4gICAgXCJwb3J0cmFpdC1zZWNvbmRhcnlcIjogMiwgLy8gYXMgLTE4MGRlZywgYWthLiAxODBkZWdcbiAgICBcImxhbmRzY2FwZS1zZWNvbmRhcnlcIjogMyAvLyBhcyAtMjcwZGVnLCBha2EuIDkwZGVnXG59XG5cbi8vXG5leHBvcnQgY29uc3QgdXBkYXRlVlAgPSAoZXY/OiBhbnkpPT57XG4gICAgY29uc3QgcnVsZSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDtcbiAgICBPYmplY3QuYXNzaWduKGF2YWlsU2l6ZSwgZ2V0QXZhaWxTaXplKCkpO1xuICAgIE9iamVjdC5lbnRyaWVzKGF2YWlsU2l6ZSkuZm9yRWFjaCgoW3Byb3BOYW1lLCBwcm9wVmFsdWVdKSA9PiB7XG4gICAgICAgIGNvbnN0IGV4aXN0cyA9IHJ1bGU/LnN0eWxlPy5nZXRQcm9wZXJ0eVZhbHVlKHByb3BOYW1lKTtcbiAgICAgICAgaWYgKCFleGlzdHMgfHwgZXhpc3RzICE9IHByb3BWYWx1ZSkge1xuICAgICAgICAgICAgcnVsZT8uc3R5bGU/LnNldFByb3BlcnR5Py4ocHJvcE5hbWUsIChwcm9wVmFsdWUgfHwgXCJcIikgYXMgc3RyaW5nLCBcIlwiKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gbWFrZSBzZWNvbmRhcnkgc2NyZWVuIG9yaWVudGF0aW9uIGRldGVjdGFibGVcbiAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkoXCItLW9yaWVudGF0aW9uLXNlY29uZGFyeVwiLCBzY3JlZW4/Lm9yaWVudGF0aW9uPy50eXBlPy5lbmRzV2l0aD8uKFwic2Vjb25kYXJ5XCIpID8gXCIxXCIgOiBcIjBcIik7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgZ2V0Q29ycmVjdE9yaWVudGF0aW9uID0gKCkgPT4ge1xuICAgIGxldCBvcmllbnRhdGlvblR5cGU6IHN0cmluZyA9IHNjcmVlbi5vcmllbnRhdGlvbi50eXBlO1xuICAgIGlmICghZ2xvYmFsVGhpcy5tYXRjaE1lZGlhKFwiKChkaXNwbGF5LW1vZGU6IGZ1bGxzY3JlZW4pIG9yIChkaXNwbGF5LW1vZGU6IHN0YW5kYWxvbmUpIG9yIChkaXNwbGF5LW1vZGU6IHdpbmRvdy1jb250cm9scy1vdmVybGF5KSlcIikubWF0Y2hlcykge1xuICAgICAgICBpZiAobWF0Y2hNZWRpYShcIihvcmllbnRhdGlvbjogcG9ydHJhaXQpXCIpLm1hdGNoZXMpIHtvcmllbnRhdGlvblR5cGUgPSBvcmllbnRhdGlvblR5cGUucmVwbGFjZShcImxhbmRzY2FwZVwiLCBcInBvcnRyYWl0XCIpO30gZWxzZVxuICAgICAgICAgICAgaWYgKG1hdGNoTWVkaWEoXCIob3JpZW50YXRpb246IGxhbmRzY2FwZSlcIikubWF0Y2hlcykge29yaWVudGF0aW9uVHlwZSA9IG9yaWVudGF0aW9uVHlwZS5yZXBsYWNlKFwicG9ydHJhaXRcIiwgXCJsYW5kc2NhcGVcIik7fTtcbiAgICB9XG4gICAgcmV0dXJuIG9yaWVudGF0aW9uVHlwZTtcbn07XG5cbi8vXG5jb25zdCBwYXNzaXZlT3B0cyA9IHsgcGFzc2l2ZTogdHJ1ZSB9O1xuXG4vL1xuZXhwb3J0IGNvbnN0IHdoZW5BbnlTY3JlZW5DaGFuZ2VzID0gKGNiKSA9PiB7XG4gICAgbGV0IHRpY2tpbmcgPSBmYWxzZTtcbiAgICBjb25zdCB1cGRhdGUgPSAoKSA9PiB7XG4gICAgICAgIGlmICghdGlja2luZykge1xuICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjYigpO1xuICAgICAgICAgICAgICAgIHRpY2tpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGlja2luZyA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgdW5zdWJzY3JpYmVyczogYW55W10gPSBbXTtcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICB1bnN1YnNjcmliZXJzLnB1c2goYWRkRXZlbnQobmF2aWdhdG9yPy52aXJ0dWFsS2V5Ym9hcmQsIFwiZ2VvbWV0cnljaGFuZ2VcIiwgdXBkYXRlLCBwYXNzaXZlT3B0cykpO1xuICAgIHVuc3Vic2NyaWJlcnMucHVzaChhZGRFdmVudCh3aW5kb3c/LnZpc3VhbFZpZXdwb3J0LCBcInNjcm9sbFwiLCB1cGRhdGUsIHBhc3NpdmVPcHRzKSk7XG4gICAgdW5zdWJzY3JpYmVycy5wdXNoKGFkZEV2ZW50KHdpbmRvdz8udmlzdWFsVmlld3BvcnQsIFwicmVzaXplXCIsIHVwZGF0ZSwgcGFzc2l2ZU9wdHMpKTtcbiAgICB1bnN1YnNjcmliZXJzLnB1c2goYWRkRXZlbnQoc2NyZWVuPy5vcmllbnRhdGlvbiwgXCJjaGFuZ2VcIiwgdXBkYXRlKSk7XG4gICAgdW5zdWJzY3JpYmVycy5wdXNoKGFkZEV2ZW50KHdpbmRvdywgXCJyZXNpemVcIiwgdXBkYXRlKSk7XG4gICAgdW5zdWJzY3JpYmVycy5wdXNoKGFkZEV2ZW50KGRvY3VtZW50Py5kb2N1bWVudEVsZW1lbnQsIFwiZnVsbHNjcmVlbmNoYW5nZVwiLCB1cGRhdGUpKTtcbiAgICB1bnN1YnNjcmliZXJzLnB1c2goYWRkRXZlbnQoZG9jdW1lbnQsIFwiRE9NQ29udGVudExvYWRlZFwiLCB1cGRhdGUpKTtcbiAgICB1bnN1YnNjcmliZXJzLnB1c2goYWRkRXZlbnQobWF0Y2hNZWRpYShcIihvcmllbnRhdGlvbjogcG9ydHJhaXQpXCIpLCBcImNoYW5nZVwiLCB1cGRhdGUpKTtcblxuICAgIC8vXG4gICAgdXBkYXRlKCk7XG4gICAgcmVxdWVzdElkbGVDYWxsYmFjayh1cGRhdGUsIHsgdGltZW91dDogMTAwIH0pO1xuICAgIHJldHVybiAoKSA9PiB1bnN1YnNjcmliZXJzLmZvckVhY2goKHVuc3ViKSA9PiB1bnN1YigpKTtcbn07XG5cbi8vXG5leHBvcnQgY29uc3QgZml4T3JpZW50VG9TY3JlZW4gPSAoZWxlbWVudCk9PntcbiAgICBpZiAoIWVsZW1lbnQ/LmNsYXNzTGlzdD8uY29udGFpbnM/LihcIm5hdGl2ZS1wb3J0cmFpdC1vcHRpbWl6ZWRcIikpIHtcbiAgICAgICAgZWxlbWVudD8uY2xhc3NMaXN0Py5hZGQ/LihcIm5hdGl2ZS1wb3J0cmFpdC1vcHRpbWl6ZWRcIik7XG4gICAgICAgIHJldHVybiB3aGVuQW55U2NyZWVuQ2hhbmdlcygoKT0+e1xuICAgICAgICAgICAgZWxlbWVudC5vcmllbnQgPSBvcmllbnRhdGlvbk51bWJlck1hcD8uW2dldENvcnJlY3RPcmllbnRhdGlvbigpXSB8fCAwO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=