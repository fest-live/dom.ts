import { unfixedClientZoom } from "./Zoom";
//
const canvas = new OffscreenCanvas(1, 1);
const ctx = canvas.getContext("2d");
//
export const initTextStyle = (element, ctx) => {
    const style = getComputedStyle(element, "");
    //
    if (ctx && style) {
        const fontWeight = (style.getPropertyValue('font-weight') || 'normal');
        const fontSize = (style.getPropertyValue('font-size') || '16px');
        const fontFamily = (style.getPropertyValue('font-family') || 'Times New Roman');
        const fontStretch = (style.getPropertyValue('font-stretch') || 'normal');
        //
        try {
            ctx.fontStretch = fontStretch.includes("%") ? "normal" : fontStretch;
        }
        catch (e) { }
        ;
        try {
            ctx.letterSpacing = (style.getPropertyValue('letter-spacing') || 'normal');
        }
        catch (e) { }
        ;
        try {
            ctx.fontKerning = (style.getPropertyValue('font-kerning') || 'auto');
        }
        catch (e) { }
        ;
        try {
            ctx.fontVariantCaps = (style.getPropertyValue('font-variant-caps') || 'normal');
        }
        catch (e) { }
        ;
        try {
            ctx.font = `${fontWeight} ${fontSize} ${fontFamily}`;
        }
        catch (e) { }
        ;
    }
};
//
export const measureText = (text, element) => {
    if (ctx) {
        initTextStyle(element, ctx);
        try {
            return ctx.measureText(text);
        }
        catch (e) { }
        ;
    }
    return { width: null };
};
//
export const measureInputInFocus = (input) => {
    const text = input.value.slice(0, input.selectionEnd || 0);
    return measureText(text, input);
};
// important: point WITHOUT padding!
export const computeCaretPosition = (input, point) => {
    const text = input?.value || "";
    if (ctx) {
        initTextStyle(input, ctx);
        let currentWidth = 0;
        for (let i = 0; i < text.length; i++) {
            currentWidth = ctx.measureText(text.slice(0, i))?.width;
            if (currentWidth == null) {
                return text.length;
            }
            ;
            if (currentWidth != null && currentWidth >= point[0]) {
                return Math.max(i - 1, 0);
            }
            ;
        }
    }
    return text.length;
};
//
export const computeCaretPositionFromClient = (input, client) => {
    const box = input.getBoundingClientRect();
    const point = [client[0] - box.left / unfixedClientZoom(), client[1] - box.top / unfixedClientZoom()];
    return computeCaretPosition(input, point);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWVhc3VyZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIk1lYXN1cmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sUUFBUSxDQUFDO0FBRTNDLEVBQUU7QUFDRixNQUFNLE1BQU0sR0FBRyxJQUFJLGVBQWUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDekMsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUVwQyxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sYUFBYSxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBQyxFQUFFO0lBQ3pDLE1BQU0sS0FBSyxHQUFHLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztJQUU1QyxFQUFFO0lBQ0YsSUFBSSxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7UUFDZixNQUFNLFVBQVUsR0FBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsSUFBSyxRQUFRLENBQUMsQ0FBQztRQUN6RSxNQUFNLFFBQVEsR0FBTSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsSUFBTyxNQUFNLENBQUMsQ0FBQztRQUN2RSxNQUFNLFVBQVUsR0FBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsSUFBSyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ2xGLE1BQU0sV0FBVyxHQUFHLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxJQUFJLFFBQVEsQ0FBc0IsQ0FBQztRQUU5RixFQUFFO1FBQ0YsSUFBSSxDQUFDO1lBQUMsR0FBRyxDQUFDLFdBQVcsR0FBTyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUFDLENBQUM7UUFBQyxPQUFN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QUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQUMsQ0FBQztZQUFBLENBQUM7UUFDdkYsQ0FBQztJQUNMLENBQUM7SUFDRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7QUFDdkIsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLDhCQUE4QixHQUFHLENBQUMsS0FBdUIsRUFBRSxNQUF3QixFQUFDLEVBQUU7SUFDL0YsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDMUMsTUFBTSxLQUFLLEdBQXFCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxJQUFJLEdBQUcsaUJBQWlCLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxpQkFBaUIsRUFBRSxDQUFDLENBQUM7SUFDeEgsT0FBTyxvQkFBb0IsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDOUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdW5maXhlZENsaWVudFpvb20gfSBmcm9tIFwiLi9ab29tXCI7XG5cbi8vXG5jb25zdCBjYW52YXMgPSBuZXcgT2Zmc2NyZWVuQ2FudmFzKDEsIDEpO1xuY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcblxuLy9cbmV4cG9ydCBjb25zdCBpbml0VGV4dFN0eWxlID0gKGVsZW1lbnQsIGN0eCk9PntcbiAgICBjb25zdCBzdHlsZSA9IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgXCJcIik7XG5cbiAgICAvL1xuICAgIGlmIChjdHggJiYgc3R5bGUpIHtcbiAgICAgICAgY29uc3QgZm9udFdlaWdodCAgPSAoc3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSgnZm9udC13ZWlnaHQnKSAgfHwgJ25vcm1hbCcpO1xuICAgICAgICBjb25zdCBmb250U2l6ZSAgICA9IChzdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCdmb250LXNpemUnKSAgICB8fCAnMTZweCcpO1xuICAgICAgICBjb25zdCBmb250RmFtaWx5ICA9IChzdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCdmb250LWZhbWlseScpICB8fCAnVGltZXMgTmV3IFJvbWFuJyk7XG4gICAgICAgIGNvbnN0IGZvbnRTdHJldGNoID0gKHN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2ZvbnQtc3RyZXRjaCcpIHx8ICdub3JtYWwnKSBhcyBDYW52YXNGb250U3RyZXRjaDtcblxuICAgICAgICAvL1xuICAgICAgICB0cnkgeyBjdHguZm9udFN0cmV0Y2ggICAgID0gZm9udFN0cmV0Y2guaW5jbHVkZXMoXCIlXCIpID8gXCJub3JtYWxcIiA6IGZvbnRTdHJldGNoOyB9IGNhdGNoKGUpIHt9O1xuICAgICAgICB0cnkgeyBjdHgubGV0dGVyU3BhY2luZyAgID0gKHN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2xldHRlci1zcGFjaW5nJykgfHwgJ25vcm1hbCcpOyB9IGNhdGNoKGUpIHt9O1xuICAgICAgICB0cnkgeyBjdHguZm9udEtlcm5pbmcgICAgID0gKHN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2ZvbnQta2VybmluZycpIHx8ICdhdXRvJykgYXMgQ2FudmFzRm9udEtlcm5pbmc7IH0gY2F0Y2goZSkge307XG4gICAgICAgIHRyeSB7IGN0eC5mb250VmFyaWFudENhcHMgPSAoc3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSgnZm9udC12YXJpYW50LWNhcHMnKSB8fCAnbm9ybWFsJykgYXMgQ2FudmFzRm9udFZhcmlhbnRDYXBzOyB9IGNhdGNoKGUpIHt9O1xuICAgICAgICB0cnkgeyBjdHguZm9udCA9IGAke2ZvbnRXZWlnaHR9ICR7Zm9udFNpemV9ICR7Zm9udEZhbWlseX1gOyB9IGNhdGNoKGUpIHt9O1xuICAgIH1cbn1cblxuLy9cbmV4cG9ydCBjb25zdCBtZWFzdXJlVGV4dCA9ICh0ZXh0LCBlbGVtZW50KT0+e1xuICAgIGlmIChjdHgpIHtcbiAgICAgICAgaW5pdFRleHRTdHlsZShlbGVtZW50LCBjdHgpO1xuICAgICAgICB0cnkgeyByZXR1cm4gY3R4Lm1lYXN1cmVUZXh0KHRleHQpOyB9IGNhdGNoKGUpIHt9O1xuICAgIH1cbiAgICByZXR1cm4geyB3aWR0aDogbnVsbCB9O1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IG1lYXN1cmVJbnB1dEluRm9jdXMgPSAoaW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnQpPT57XG4gICAgY29uc3QgdGV4dCA9IGlucHV0LnZhbHVlLnNsaWNlKDAsIGlucHV0LnNlbGVjdGlvbkVuZCB8fCAwKTtcbiAgICByZXR1cm4gbWVhc3VyZVRleHQodGV4dCwgaW5wdXQpO1xufVxuXG4vLyBpbXBvcnRhbnQ6IHBvaW50IFdJVEhPVVQgcGFkZGluZyFcbmV4cG9ydCBjb25zdCBjb21wdXRlQ2FyZXRQb3NpdGlvbiA9IChpbnB1dDogSFRNTElucHV0RWxlbWVudCwgcG9pbnQ6IFtudW1iZXIsIG51bWJlcl0pPT57XG4gICAgY29uc3QgdGV4dCAgPSBpbnB1dD8udmFsdWUgfHwgXCJcIjtcbiAgICBpZiAoY3R4KSB7XG4gICAgICAgIGluaXRUZXh0U3R5bGUoaW5wdXQsIGN0eCk7XG4gICAgICAgIGxldCBjdXJyZW50V2lkdGggPSAwO1xuICAgICAgICBmb3IgKGxldCBpPTA7aTx0ZXh0Lmxlbmd0aDtpKyspIHtcbiAgICAgICAgICAgIGN1cnJlbnRXaWR0aCA9IGN0eC5tZWFzdXJlVGV4dCh0ZXh0LnNsaWNlKDAsIGkpKT8ud2lkdGg7XG4gICAgICAgICAgICBpZiAoY3VycmVudFdpZHRoID09IG51bGwpIHsgcmV0dXJuIHRleHQubGVuZ3RoOyB9O1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRXaWR0aCAhPSBudWxsICYmIGN1cnJlbnRXaWR0aCA+PSBwb2ludFswXSkgeyByZXR1cm4gTWF0aC5tYXgoaS0xLCAwKTsgfTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGV4dC5sZW5ndGg7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgY29tcHV0ZUNhcmV0UG9zaXRpb25Gcm9tQ2xpZW50ID0gKGlucHV0OiBIVE1MSW5wdXRFbGVtZW50LCBjbGllbnQ6IFtudW1iZXIsIG51bWJlcl0pPT57XG4gICAgY29uc3QgYm94ID0gaW5wdXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3QgcG9pbnQ6IFtudW1iZXIsIG51bWJlcl0gPSBbY2xpZW50WzBdIC0gYm94LmxlZnQgLyB1bmZpeGVkQ2xpZW50Wm9vbSgpLCBjbGllbnRbMV0gLSBib3gudG9wIC8gdW5maXhlZENsaWVudFpvb20oKV07XG4gICAgcmV0dXJuIGNvbXB1dGVDYXJldFBvc2l0aW9uKGlucHV0LCBwb2ludCk7XG59XG4iXX0=