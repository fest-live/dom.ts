import { makeRAFCycle } from "../agate/Utils";
//
const blobImageMap = new WeakMap(), delayed = new Map([]);
const sheduler = makeRAFCycle();
//
const getImgWidth = (img) => {
    return img?.naturalWidth || img?.width || 1;
};
//
const getImgHeight = (img) => {
    return img?.naturalHeight || img?.height || 1;
};
//
export const callByFrame = (pointerId, cb) => { delayed.set(pointerId, cb); };
export const cover = (ctx, img, scale = 1, port, orient = 0) => {
    const canvas = ctx.canvas;
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.rotate((-orient || 0) * (Math.PI * 0.5));
    ctx.rotate((1 - port) * (Math.PI / 2));
    ctx.translate(-(getImgWidth(img) / 2) * scale, -(getImgHeight(img) / 2) * scale);
};
//
export const createImageBitmapCache = (blob) => {
    if (!blobImageMap.has(blob) && (blob instanceof Blob || blob instanceof File || blob instanceof OffscreenCanvas || blob instanceof ImageBitmap || blob instanceof Image)) {
        blobImageMap.set(blob, createImageBitmap(blob));
    }
    return blobImageMap.get(blob);
};
//
const bindCache = new WeakMap();
const bindCached = (cb, ctx) => {
    // @ts-ignore
    return bindCache?.getOrInsertComputed?.(cb, () => cb?.bind?.(ctx));
};
//
let UICanvas = null;
if (typeof HTMLCanvasElement != "undefined") {
    UICanvas = class UICanvas extends HTMLCanvasElement {
        static observedAttributes = ["data-src", "data-orient"];
        //
        ctx = null;
        image = null;
        #size = [1, 1];
        #loading = "";
        #ready = "";
        //
        get #orient() { return parseInt(this.getAttribute("data-orient") || "0") || 0; }
        set #orient(value) { this.setAttribute("data-orient", value.toString()); }
        //
        attributeChangedCallback(name, _, newValue) {
            if (name == "data-src") {
                this.#preload(newValue);
            }
            ;
            if (name == "data-orient") {
                this.#render(this.#ready);
            }
            ;
        }
        //
        connectedCallback() {
            const parent = this.parentNode;
            this.style.setProperty("max-inline-size", "min(100%, min(100cqi, 100dvi))");
            this.style.setProperty("max-block-size", "min(100%, min(100cqb, 100dvb))");
            this.#size = [
                Math.min(Math.min(Math.max(this.clientWidth || parent?.clientWidth || 1, 1), parent?.clientWidth || 1) * (this.currentCSSZoom || 1), screen?.width || 1) * (devicePixelRatio || 1), // @ts-ignore
                Math.min(Math.min(Math.max(this.clientHeight || parent?.clientHeight || 1, 1), parent?.clientHeight || 1) * (this.currentCSSZoom || 1), screen?.height || 1) * (devicePixelRatio || 1)
            ];
            this.#preload(this.#loading = this.dataset.src || this.#loading);
        }
        //
        constructor() {
            super();
            //
            const canvas = this;
            const parent = this.parentNode;
            //
            const fixSize = () => {
                const old = this.#size;
                this.#size = [
                    Math.min(Math.min(Math.max(this.clientWidth || parent?.clientWidth || 1, 1), parent?.clientWidth || 1) * (this.currentCSSZoom || 1), screen?.width || 1) * (devicePixelRatio || 1), // @ts-ignore
                    Math.min(Math.min(Math.max(this.clientHeight || parent?.clientHeight || 1, 1), parent?.clientHeight || 1) * (this.currentCSSZoom || 1), screen?.height || 1) * (devicePixelRatio || 1)
                ];
                //
                if (old?.[0] != this.#size[0] || old?.[1] != this.#size[1]) {
                    this.#render(this.#ready);
                }
            };
            //
            sheduler?.shedule?.(() => {
                this.ctx = canvas.getContext("2d", {
                    alpha: true,
                    desynchronized: true,
                    powerPreference: "high-performance",
                    preserveDrawingBuffer: true
                });
                //
                this.inert = true;
                this.style.objectFit = "cover";
                this.style.objectPosition = "center";
                this.classList.add("u-canvas");
                this.classList.add("u2-canvas");
                this.classList.add("ui-canvas");
                //
                this.style.setProperty("max-inline-size", "min(100%, min(100cqi, 100dvi))");
                this.style.setProperty("max-block-size", "min(100%, min(100cqb, 100dvb))");
                //
                fixSize();
                //
                new ResizeObserver((entries) => {
                    for (const entry of entries) {
                        const box = entry?.devicePixelContentBoxSize?.[0];
                        if (box) {
                            const old = this.#size;
                            this.#size = [
                                Math.max(/*contentBox.inlineSize * devicePixelRatio*/ box.inlineSize || this.width, 1),
                                Math.max(/*contentBox.blockSize  * devicePixelRatio*/ box.blockSize || this.height, 1)
                            ];
                            if (old?.[0] != this.#size[0] || old?.[1] != this.#size[1]) {
                                this.#render(this.#ready);
                            }
                        }
                    }
                }).observe(this, { box: "device-pixel-content-box" });
                //
                this.#preload(this.#loading = this.dataset.src || this.#loading);
            });
        }
        //
        async $useImageAsSource(blob, ready) {
            ready ||= this.#loading;
            const img = (blob instanceof ImageBitmap) ? blob : (await createImageBitmapCache(blob).catch(console.warn.bind(console)));
            if (img && ready == this.#loading) {
                this.image = img;
                this.#render(ready);
            }
            return blob;
        }
        //
        $renderPass(whatIsReady) {
            const canvas = this, ctx = this.ctx, img = this.image;
            if (img && ctx && (whatIsReady == this.#loading || !whatIsReady)) {
                if (whatIsReady) {
                    this.#ready = whatIsReady;
                }
                ;
                if (this.width != this.#size[0]) {
                    this.width = this.#size[0];
                }
                ;
                if (this.height != this.#size[1]) {
                    this.height = this.#size[1];
                }
                ;
                this.style.aspectRatio = `${this.width || 1} / ${this.height || 1}`;
                //this.style.containIntrinsicInlineSize = `${this.width  || 1}px`;
                //this.style.containIntrinsicBlockSize  = `${this.height || 1}px`;
                //
                const ox = (this.#orient % 2) || 0;
                const port = getImgWidth(img) <= getImgHeight(img) ? 1 : 0;
                const scale = Math.max(canvas[["height", "width"][ox]] / (port ? getImgHeight(img) : getImgWidth(img)), canvas[["width", "height"][ox]] / (port ? getImgWidth(img) : getImgHeight(img)));
                //
                ctx.save();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                cover(ctx, img, scale, port, this.#orient);
                ctx.drawImage(img, 0, 0, img.width * scale, img.height * scale);
                ctx.restore();
            }
        }
        //
        #preload(src) {
            const ready = src || this.#loading;
            this.#loading = ready;
            return fetch(src, {
                cache: "force-cache",
                mode: "same-origin",
                priority: "high",
            })?.then?.(async (rsp) => this.$useImageAsSource(await rsp.blob(), ready)?.catch(console.warn.bind(console)))?.catch?.(console.warn.bind(console));
        }
        #render(whatIsReady) {
            const ctx = this.ctx, img = this.image;
            if (img && ctx && (whatIsReady == this.#loading || !whatIsReady)) {
                sheduler?.shedule?.(bindCached(this.$renderPass, this));
            }
        }
    };
}
else {
    UICanvas = class UICanvas {
        constructor() { }
        $renderPass(whatIsReady) { }
        $useImageAsSource(blob, ready) { return blob; }
        #preload(src) { return Promise.resolve(); }
        #render(whatIsReady) { }
        #orient = 0;
        #loading = "";
        #ready = "";
        #size = [1, 1];
        ctx = null;
        image = null;
    };
}
//
export { UICanvas };
export default UICanvas;
//
try {
    customElements.define('ui-canvas', UICanvas, { extends: 'canvas' });
}
catch (e) { }
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FudmFzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQ2FudmFzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU5QyxFQUFFO0FBQ0YsTUFBTSxZQUFZLEdBQUcsSUFBSSxPQUFPLEVBQUUsRUFBRSxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQTBCLEVBQUUsQ0FBQyxDQUFDO0FBQ25GLE1BQU0sUUFBUSxHQUFHLFlBQVksRUFBRSxDQUFDO0FBRWhDLEVBQUU7QUFDRixNQUFNLFdBQVcsR0FBRyxDQUFDLEdBQUcsRUFBQyxFQUFFO0lBQ3ZCLE9BQU8sR0FBRyxFQUFFLFlBQVksSUFBSSxHQUFHLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQztBQUNoRCxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFHLEVBQUMsRUFBRTtJQUN4QixPQUFPLEdBQUcsRUFBRSxhQUFhLElBQUksR0FBRyxFQUFFLE1BQU0sSUFBSSxDQUFDLENBQUM7QUFDbEQsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxDQUFDLFNBQVMsRUFBRSxFQUFFLEVBQUMsRUFBRSxHQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQzNFLE1BQU0sQ0FBQyxNQUFNLEtBQUssR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxHQUFHLENBQUMsRUFBRSxFQUFFO0lBQzNELE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7SUFDMUIsR0FBRyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLENBQUMsRUFBRSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lB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RUFBRSxPQUFPLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQUMsQ0FBQztRQUNsSSxDQUFDO0tBQ0osQ0FBQTtBQUNMLENBQUM7S0FBTSxDQUFDO0lBQ0osUUFBUSxHQUFHLE1BQU0sUUFBUTtRQUNyQixnQkFBZ0IsQ0FBQztRQUNqQixXQUFXLENBQUMsV0FBa0MsSUFBSSxDQUFDO1FBQ25ELGlCQUFpQixDQUFDLElBQUksRUFBRSxLQUFrQixJQUFJLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM1RCxRQUFRLENBQUMsR0FBRyxJQUFJLE9BQU8sT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMzQyxPQUFPLENBQUMsV0FBa0MsSUFBSSxDQUFDO1FBQy9DLE9BQU8sR0FBVyxDQUFDLENBQUM7UUFDcEIsUUFBUSxHQUF5QixFQUFFLENBQUM7UUFDcEMsTUFBTSxHQUF5QixFQUFFLENBQUM7UUFDbEMsS0FBSyxHQUFxQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNqQyxHQUFHLEdBQW9DLElBQUksQ0FBQztRQUM1QyxLQUFLLEdBQXVCLElBQUksQ0FBQztLQUNwQyxDQUFBO0FBQ0wsQ0FBQztBQUVELEVBQUU7QUFDRixPQUFPLEVBQUUsUUFBUSxFQUFFLENBQUM7QUFDcEIsZUFBZSxRQUFRLENBQUM7QUFFeEIsRUFBRTtBQUNGLElBQUksQ0FBQztJQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxFQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUMsQ0FBQyxDQUFDO0FBQUMsQ0FBQztBQUFDLE9BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQSxDQUFDO0FBQUEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1ha2VSQUZDeWNsZSB9IGZyb20gXCIuLi9hZ2F0ZS9VdGlsc1wiO1xuXG4vL1xuY29uc3QgYmxvYkltYWdlTWFwID0gbmV3IFdlYWtNYXAoKSwgZGVsYXllZCA9IG5ldyBNYXA8bnVtYmVyLCBGdW5jdGlvbiB8IG51bGw+KFtdKTtcbmNvbnN0IHNoZWR1bGVyID0gbWFrZVJBRkN5Y2xlKCk7XG5cbi8vXG5jb25zdCBnZXRJbWdXaWR0aCA9IChpbWcpPT57XG4gICAgcmV0dXJuIGltZz8ubmF0dXJhbFdpZHRoIHx8IGltZz8ud2lkdGggfHwgMTtcbn1cblxuLy9cbmNvbnN0IGdldEltZ0hlaWdodCA9IChpbWcpPT57XG4gICAgcmV0dXJuIGltZz8ubmF0dXJhbEhlaWdodCB8fCBpbWc/LmhlaWdodCB8fCAxO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGNhbGxCeUZyYW1lID0gKHBvaW50ZXJJZCwgY2IpPT57IGRlbGF5ZWQuc2V0KHBvaW50ZXJJZCwgY2IpOyB9XG5leHBvcnQgY29uc3QgY292ZXIgPSAoY3R4LCBpbWcsIHNjYWxlID0gMSwgcG9ydCwgb3JpZW50ID0gMCkgPT4ge1xuICAgIGNvbnN0IGNhbnZhcyA9IGN0eC5jYW52YXM7XG4gICAgY3R4LnRyYW5zbGF0ZShjYW52YXMud2lkdGggLyAyLCBjYW52YXMuaGVpZ2h0IC8gMik7XG4gICAgY3R4LnJvdGF0ZSgoLW9yaWVudCB8fCAwKSAqIChNYXRoLlBJICogMC41KSk7XG4gICAgY3R4LnJvdGF0ZSgoMSAtIHBvcnQpICogKE1hdGguUEkgLyAyKSk7XG4gICAgY3R4LnRyYW5zbGF0ZSgtKGdldEltZ1dpZHRoKGltZykgLyAyKSAqIHNjYWxlLCAtKGdldEltZ0hlaWdodChpbWcpIC8gMikgKiBzY2FsZSk7XG59O1xuXG4vL1xuZXhwb3J0IGNvbnN0IGNyZWF0ZUltYWdlQml0bWFwQ2FjaGUgPSAoYmxvYik9PntcbiAgICBpZiAoIWJsb2JJbWFnZU1hcC5oYXMoYmxvYikgJiYgKGJsb2IgaW5zdGFuY2VvZiBCbG9iIHx8IGJsb2IgaW5zdGFuY2VvZiBGaWxlIHx8IGJsb2IgaW5zdGFuY2VvZiBPZmZzY3JlZW5DYW52YXMgfHwgYmxvYiBpbnN0YW5jZW9mIEltYWdlQml0bWFwIHx8IGJsb2IgaW5zdGFuY2VvZiBJbWFnZSkpIHtcbiAgICAgICAgYmxvYkltYWdlTWFwLnNldChibG9iLCBjcmVhdGVJbWFnZUJpdG1hcChibG9iKSk7XG4gICAgfVxuICAgIHJldHVybiBibG9iSW1hZ2VNYXAuZ2V0KGJsb2IpO1xufVxuXG4vL1xuY29uc3QgYmluZENhY2hlID0gbmV3IFdlYWtNYXAoKTtcbmNvbnN0IGJpbmRDYWNoZWQgPSAoY2IsIGN0eCk9PntcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcmV0dXJuIGJpbmRDYWNoZT8uZ2V0T3JJbnNlcnRDb21wdXRlZD8uKGNiLCAoKT0+IGNiPy5iaW5kPy4oY3R4KSk7XG59XG5cbi8vXG5sZXQgVUlDYW52YXM6IGFueSA9IG51bGw7XG5pZiAodHlwZW9mIEhUTUxDYW52YXNFbGVtZW50ICE9IFwidW5kZWZpbmVkXCIpIHtcbiAgICBVSUNhbnZhcyA9IGNsYXNzIFVJQ2FudmFzIGV4dGVuZHMgSFRNTENhbnZhc0VsZW1lbnQge1xuICAgICAgICBzdGF0aWMgb2JzZXJ2ZWRBdHRyaWJ1dGVzID0gW1wiZGF0YS1zcmNcIiwgXCJkYXRhLW9yaWVudFwiXTtcblxuICAgICAgICAvL1xuICAgICAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCB8IG51bGwgPSBudWxsO1xuICAgICAgICBpbWFnZTogSW1hZ2VCaXRtYXAgfCBudWxsID0gbnVsbDtcbiAgICAgICAgI3NpemU6IFtudW1iZXIsIG51bWJlcl0gPSBbMSwgMV07XG4gICAgICAgICNsb2FkaW5nOiBzdHJpbmcgfCBCbG9iIHwgRmlsZSA9IFwiXCI7XG4gICAgICAgICNyZWFkeTogc3RyaW5nIHwgQmxvYiB8IEZpbGUgPSBcIlwiO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGdldCAjb3JpZW50KCkgeyByZXR1cm4gcGFyc2VJbnQodGhpcy5nZXRBdHRyaWJ1dGUoXCJkYXRhLW9yaWVudFwiKSB8fCBcIjBcIikgfHwgMDsgfVxuICAgICAgICBzZXQgI29yaWVudCh2YWx1ZTogbnVtYmVyKSB7IHRoaXMuc2V0QXR0cmlidXRlKFwiZGF0YS1vcmllbnRcIiwgdmFsdWUudG9TdHJpbmcoKSk7IH1cblxuICAgICAgICAvL1xuICAgICAgICBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgXywgbmV3VmFsdWUpIHtcbiAgICAgICAgICAgIGlmIChuYW1lID09IFwiZGF0YS1zcmNcIikgeyB0aGlzLiNwcmVsb2FkKG5ld1ZhbHVlKTsgfTtcbiAgICAgICAgICAgIGlmIChuYW1lID09IFwiZGF0YS1vcmllbnRcIikgeyB0aGlzLiNyZW5kZXIodGhpcy4jcmVhZHkpOyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgICAgICBjb25zdCBwYXJlbnQ6IEhUTUxFbGVtZW50ID0gdGhpcy5wYXJlbnROb2RlIGFzIEhUTUxFbGVtZW50O1xuICAgICAgICAgICAgdGhpcy5zdHlsZS5zZXRQcm9wZXJ0eShcIm1heC1pbmxpbmUtc2l6ZVwiLCBcIm1pbigxMDAlLCBtaW4oMTAwY3FpLCAxMDBkdmkpKVwiKTtcbiAgICAgICAgICAgIHRoaXMuc3R5bGUuc2V0UHJvcGVydHkoXCJtYXgtYmxvY2stc2l6ZVwiLCBcIm1pbigxMDAlLCBtaW4oMTAwY3FiLCAxMDBkdmIpKVwiKTtcbiAgICAgICAgICAgIHRoaXMuI3NpemUgPSBbIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICBNYXRoLm1pbihNYXRoLm1pbihNYXRoLm1heCh0aGlzLmNsaWVudFdpZHRoIHx8IHBhcmVudD8uY2xpZW50V2lkdGggfHwgMSwgMSksIHBhcmVudD8uY2xpZW50V2lkdGggfHwgMSkgKiAodGhpcy5jdXJyZW50Q1NTWm9vbSB8fCAxKSwgc2NyZWVuPy53aWR0aCB8fCAxKSAqIChkZXZpY2VQaXhlbFJhdGlvIHx8IDEpLCAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgTWF0aC5taW4oTWF0aC5taW4oTWF0aC5tYXgodGhpcy5jbGllbnRIZWlnaHQgfHwgcGFyZW50Py5jbGllbnRIZWlnaHQgfHwgMSwgMSksIHBhcmVudD8uY2xpZW50SGVpZ2h0IHx8IDEpICogKHRoaXMuY3VycmVudENTU1pvb20gfHwgMSksIHNjcmVlbj8uaGVpZ2h0IHx8IDEpICogKGRldmljZVBpeGVsUmF0aW8gfHwgMSlcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgICB0aGlzLiNwcmVsb2FkKHRoaXMuI2xvYWRpbmcgPSB0aGlzLmRhdGFzZXQuc3JjIHx8IHRoaXMuI2xvYWRpbmcpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcyBhcyBIVE1MQ2FudmFzRWxlbWVudDtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZSBhcyBIVE1MRWxlbWVudDtcblxuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIGNvbnN0IGZpeFNpemUgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgb2xkID0gdGhpcy4jc2l6ZTtcbiAgICAgICAgICAgICAgICB0aGlzLiNzaXplID0gWyAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgICAgIE1hdGgubWluKE1hdGgubWluKE1hdGgubWF4KHRoaXMuY2xpZW50V2lkdGggfHwgcGFyZW50Py5jbGllbnRXaWR0aCB8fCAxLCAxKSwgcGFyZW50Py5jbGllbnRXaWR0aCB8fCAxKSAqICh0aGlzLmN1cnJlbnRDU1Nab29tIHx8IDEpLCBzY3JlZW4/LndpZHRoIHx8IDEpICogKGRldmljZVBpeGVsUmF0aW8gfHwgMSksIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgTWF0aC5taW4oTWF0aC5taW4oTWF0aC5tYXgodGhpcy5jbGllbnRIZWlnaHQgfHwgcGFyZW50Py5jbGllbnRIZWlnaHQgfHwgMSwgMSksIHBhcmVudD8uY2xpZW50SGVpZ2h0IHx8IDEpICogKHRoaXMuY3VycmVudENTU1pvb20gfHwgMSksIHNjcmVlbj8uaGVpZ2h0IHx8IDEpICogKGRldmljZVBpeGVsUmF0aW8gfHwgMSlcbiAgICAgICAgICAgICAgICBdO1xuXG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICBpZiAob2xkPy5bMF0gIT0gdGhpcy4jc2l6ZVswXSB8fCBvbGQ/LlsxXSAhPSB0aGlzLiNzaXplWzFdKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuI3JlbmRlcih0aGlzLiNyZWFkeSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgc2hlZHVsZXI/LnNoZWR1bGU/LigoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jdHggPSBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIsIHtcbiAgICAgICAgICAgICAgICAgICAgYWxwaGE6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGRlc3luY2hyb25pemVkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBwb3dlclByZWZlcmVuY2U6IFwiaGlnaC1wZXJmb3JtYW5jZVwiLFxuICAgICAgICAgICAgICAgICAgICBwcmVzZXJ2ZURyYXdpbmdCdWZmZXI6IHRydWVcbiAgICAgICAgICAgICAgICB9KSBhcyBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XG5cbiAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgIHRoaXMuaW5lcnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMuc3R5bGUub2JqZWN0Rml0ID0gXCJjb3ZlclwiO1xuICAgICAgICAgICAgICAgIHRoaXMuc3R5bGUub2JqZWN0UG9zaXRpb24gPSBcImNlbnRlclwiO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xhc3NMaXN0LmFkZChcInUtY2FudmFzXCIpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xhc3NMaXN0LmFkZChcInUyLWNhbnZhc1wiKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsYXNzTGlzdC5hZGQoXCJ1aS1jYW52YXNcIik7XG5cbiAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgIHRoaXMuc3R5bGUuc2V0UHJvcGVydHkoXCJtYXgtaW5saW5lLXNpemVcIiwgXCJtaW4oMTAwJSwgbWluKDEwMGNxaSwgMTAwZHZpKSlcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5zdHlsZS5zZXRQcm9wZXJ0eShcIm1heC1ibG9jay1zaXplXCIsIFwibWluKDEwMCUsIG1pbigxMDBjcWIsIDEwMGR2YikpXCIpO1xuXG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICBmaXhTaXplKCk7XG5cbiAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgIG5ldyBSZXNpemVPYnNlcnZlcigoZW50cmllcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGVudHJpZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IGVudHJ5Py5kZXZpY2VQaXhlbENvbnRlbnRCb3hTaXplPy5bMF07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYm94KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2xkID0gdGhpcy4jc2l6ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiNzaXplID0gWyAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGgubWF4KC8qY29udGVudEJveC5pbmxpbmVTaXplICogZGV2aWNlUGl4ZWxSYXRpbyovYm94LmlubGluZVNpemUgfHwgdGhpcy53aWR0aCwgMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGgubWF4KC8qY29udGVudEJveC5ibG9ja1NpemUgICogZGV2aWNlUGl4ZWxSYXRpbyovYm94LmJsb2NrU2l6ZSB8fCB0aGlzLmhlaWdodCwgMSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGQ/LlswXSAhPSB0aGlzLiNzaXplWzBdIHx8IG9sZD8uWzFdICE9IHRoaXMuI3NpemVbMV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4jcmVuZGVyKHRoaXMuI3JlYWR5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KS5vYnNlcnZlKHRoaXMsIHsgYm94OiBcImRldmljZS1waXhlbC1jb250ZW50LWJveFwiIH0pO1xuXG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICB0aGlzLiNwcmVsb2FkKHRoaXMuI2xvYWRpbmcgPSB0aGlzLmRhdGFzZXQuc3JjIHx8IHRoaXMuI2xvYWRpbmcpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvL1xuICAgICAgICBhc3luYyAkdXNlSW1hZ2VBc1NvdXJjZShibG9iLCByZWFkeT86IGFueSB8IG51bGwpIHtcbiAgICAgICAgICAgIHJlYWR5IHx8PSB0aGlzLiNsb2FkaW5nO1xuICAgICAgICAgICAgY29uc3QgaW1nID0gKGJsb2IgaW5zdGFuY2VvZiBJbWFnZUJpdG1hcCkgPyBibG9iIDogKGF3YWl0IGNyZWF0ZUltYWdlQml0bWFwQ2FjaGUoYmxvYikuY2F0Y2goY29uc29sZS53YXJuLmJpbmQoY29uc29sZSkpKTtcbiAgICAgICAgICAgIGlmIChpbWcgJiYgcmVhZHkgPT0gdGhpcy4jbG9hZGluZykgeyB0aGlzLmltYWdlID0gaW1nOyB0aGlzLiNyZW5kZXIocmVhZHkpOyB9XG4gICAgICAgICAgICByZXR1cm4gYmxvYjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vXG4gICAgICAgICRyZW5kZXJQYXNzKHdoYXRJc1JlYWR5PzogRmlsZSB8IEJsb2IgfCBzdHJpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMsIGN0eCA9IHRoaXMuY3R4LCBpbWcgPSB0aGlzLmltYWdlO1xuICAgICAgICAgICAgaWYgKGltZyAmJiBjdHggJiYgKHdoYXRJc1JlYWR5ID09IHRoaXMuI2xvYWRpbmcgfHwgIXdoYXRJc1JlYWR5KSkge1xuICAgICAgICAgICAgICAgIGlmICh3aGF0SXNSZWFkeSkgeyB0aGlzLiNyZWFkeSA9IHdoYXRJc1JlYWR5OyB9O1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLndpZHRoICE9IHRoaXMuI3NpemVbMF0pIHsgdGhpcy53aWR0aCA9IHRoaXMuI3NpemVbMF07IH07XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaGVpZ2h0ICE9IHRoaXMuI3NpemVbMV0pIHsgdGhpcy5oZWlnaHQgPSB0aGlzLiNzaXplWzFdOyB9O1xuICAgICAgICAgICAgICAgIHRoaXMuc3R5bGUuYXNwZWN0UmF0aW8gPSBgJHt0aGlzLndpZHRoIHx8IDF9IC8gJHt0aGlzLmhlaWdodCB8fCAxfWA7XG4gICAgICAgICAgICAgICAgLy90aGlzLnN0eWxlLmNvbnRhaW5JbnRyaW5zaWNJbmxpbmVTaXplID0gYCR7dGhpcy53aWR0aCAgfHwgMX1weGA7XG4gICAgICAgICAgICAgICAgLy90aGlzLnN0eWxlLmNvbnRhaW5JbnRyaW5zaWNCbG9ja1NpemUgID0gYCR7dGhpcy5oZWlnaHQgfHwgMX1weGA7XG5cbiAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgIGNvbnN0IG94ID0gKHRoaXMuI29yaWVudCAlIDIpIHx8IDA7XG4gICAgICAgICAgICAgICAgY29uc3QgcG9ydCA9IGdldEltZ1dpZHRoKGltZykgPD0gZ2V0SW1nSGVpZ2h0KGltZykgPyAxIDogMDtcbiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZSA9IE1hdGgubWF4KFxuICAgICAgICAgICAgICAgICAgICBjYW52YXNbW1wiaGVpZ2h0XCIsIFwid2lkdGhcIl1bb3hdXSAvIChwb3J0ID8gZ2V0SW1nSGVpZ2h0KGltZykgOiBnZXRJbWdXaWR0aChpbWcpKSxcbiAgICAgICAgICAgICAgICAgICAgY2FudmFzW1tcIndpZHRoXCIsIFwiaGVpZ2h0XCJdW294XV0gLyAocG9ydCA/IGdldEltZ1dpZHRoKGltZykgOiBnZXRJbWdIZWlnaHQoaW1nKSlcbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICBjdHguc2F2ZSgpO1xuICAgICAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsgY292ZXIoY3R4LCBpbWcsIHNjYWxlLCBwb3J0LCB0aGlzLiNvcmllbnQpO1xuICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCBpbWcud2lkdGggKiBzY2FsZSwgaW1nLmhlaWdodCAqIHNjYWxlKTtcbiAgICAgICAgICAgICAgICBjdHgucmVzdG9yZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgI3ByZWxvYWQoc3JjKSB7XG4gICAgICAgICAgICBjb25zdCByZWFkeSA9IHNyYyB8fCB0aGlzLiNsb2FkaW5nOyB0aGlzLiNsb2FkaW5nID0gcmVhZHk7IHJldHVybiBmZXRjaChzcmMsIHtcbiAgICAgICAgICAgIGNhY2hlOiBcImZvcmNlLWNhY2hlXCIsXG4gICAgICAgICAgICBtb2RlOiBcInNhbWUtb3JpZ2luXCIsXG4gICAgICAgICAgICBwcmlvcml0eTogXCJoaWdoXCIsXG4gICAgICAgIH0pPy50aGVuPy4oYXN5bmMgKHJzcCkgPT4gdGhpcy4kdXNlSW1hZ2VBc1NvdXJjZShhd2FpdCByc3AuYmxvYigpLCByZWFkeSk/LmNhdGNoKGNvbnNvbGUud2Fybi5iaW5kKGNvbnNvbGUpKSk/LmNhdGNoPy4oY29uc29sZS53YXJuLmJpbmQoY29uc29sZSkpOyB9XG4gICAgICAgICNyZW5kZXIod2hhdElzUmVhZHk/OiBGaWxlIHwgQmxvYiB8IHN0cmluZykge1xuICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHgsIGltZyA9IHRoaXMuaW1hZ2U7XG4gICAgICAgICAgICBpZiAoaW1nICYmIGN0eCAmJiAod2hhdElzUmVhZHkgPT0gdGhpcy4jbG9hZGluZyB8fCAhd2hhdElzUmVhZHkpKSB7IHNoZWR1bGVyPy5zaGVkdWxlPy4oYmluZENhY2hlZCh0aGlzLiRyZW5kZXJQYXNzLCB0aGlzKSk7IH1cbiAgICAgICAgfVxuICAgIH1cbn0gZWxzZSB7XG4gICAgVUlDYW52YXMgPSBjbGFzcyBVSUNhbnZhcyB7XG4gICAgICAgIGNvbnN0cnVjdG9yKCkgeyB9XG4gICAgICAgICRyZW5kZXJQYXNzKHdoYXRJc1JlYWR5PzogRmlsZSB8IEJsb2IgfCBzdHJpbmcpIHsgfVxuICAgICAgICAkdXNlSW1hZ2VBc1NvdXJjZShibG9iLCByZWFkeT86IGFueSB8IG51bGwpIHsgcmV0dXJuIGJsb2I7IH1cbiAgICAgICAgI3ByZWxvYWQoc3JjKSB7IHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsgfVxuICAgICAgICAjcmVuZGVyKHdoYXRJc1JlYWR5PzogRmlsZSB8IEJsb2IgfCBzdHJpbmcpIHsgfVxuICAgICAgICAjb3JpZW50OiBudW1iZXIgPSAwO1xuICAgICAgICAjbG9hZGluZzogc3RyaW5nIHwgQmxvYiB8IEZpbGUgPSBcIlwiO1xuICAgICAgICAjcmVhZHk6IHN0cmluZyB8IEJsb2IgfCBGaWxlID0gXCJcIjtcbiAgICAgICAgI3NpemU6IFtudW1iZXIsIG51bWJlcl0gPSBbMSwgMV07XG4gICAgICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEIHwgbnVsbCA9IG51bGw7XG4gICAgICAgIGltYWdlOiBJbWFnZUJpdG1hcCB8IG51bGwgPSBudWxsO1xuICAgIH1cbn1cblxuLy9cbmV4cG9ydCB7IFVJQ2FudmFzIH07XG5leHBvcnQgZGVmYXVsdCBVSUNhbnZhcztcblxuLy9cbnRyeSB7IGN1c3RvbUVsZW1lbnRzLmRlZmluZSgndWktY2FudmFzJywgVUlDYW52YXMsIHtleHRlbmRzOiAnY2FudmFzJ30pOyB9IGNhdGNoKGUpIHt9O1xuIl19