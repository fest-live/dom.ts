import { isMobile } from "../agate/Detect";
import { addEvents } from "../agate/Utils";
//
export const animateShow = async (target) => {
    //
    const animationDone = () => {
        if (!target?.hasAttribute?.("data-hidden")) {
            target?.removeAttribute?.("data-opacity-animation");
            target?.dispatchEvent?.(new CustomEvent("u2-appear", {
                detail: {},
                bubbles: true,
                cancelable: true
            }));
        }
    };
    //
    if (!target?.hasAttribute?.("data-hidden") && target?.dispatchEvent?.(new CustomEvent("u2-before-show", {
        detail: {},
        bubbles: true,
        cancelable: true
    }))) {
        //
        if (!matchMedia("(prefers-reduced-motion: reduce)").matches && !target.hasAttribute("data-opacity-animation") && !target.hasAttribute("data-instant") && target?.getAttribute?.("data-hidden") == null) {
            target.setAttribute("data-opacity-animation", "");
        }
        //
        if (target.hasAttribute("data-opacity-animation") && target?.getAttribute?.("data-hidden") == null) {
            const animate = target.animate([
                {
                    easing: "linear",
                    offset: 0,
                    //
                    "--opacity": 0,
                    "--scale": 0.8,
                    display: "none",
                    pointerEvents: "none"
                },
                {
                    easing: "linear",
                    offset: 0.01,
                    //
                    "--opacity": 0,
                    "--scale": 0.8,
                    display: "none",
                    pointerEvents: "none"
                },
                {
                    easing: "linear",
                    offset: 1,
                    //
                    "--opacity": 1,
                    "--scale": 1,
                    display: "revert-layer",
                    pointerEvents: "revert-layer"
                }
            ], {
                //fill: "forwards",
                duration: isMobile() ? 100 : 80,
                easing: "linear",
                delay: 0
                //rangeStart: "cover 0%",
                //rangeEnd: "cover 100%",
            });
            //
            let done = false;
            const endAnimation = () => {
                if (done) {
                    return;
                }
                ;
                done = true;
                events?.forEach?.((event) => event?.());
                animate.currentTime = 1;
                animate.finish();
                animationDone?.();
            };
            //
            const abth = [endAnimation, { once: true, passive: true }];
            const abts = [endAnimation, { once: true, passive: true }];
            //
            const events = addEvents(target, {
                "u2-before-hide": abth,
                "u2-before-show": abts
            });
            //
            await animate.finished;
            endAnimation?.();
        }
        else {
            // @ts-ignore
            const { resolve, reject, promise } = Promise.withResolvers();
            const req = requestAnimationFrame(resolve);
            //
            let done = false;
            const endAnimation = () => {
                if (done) {
                    return;
                }
                ;
                done = true;
                events?.forEach?.((event) => event?.());
                cancelAnimationFrame(req);
                resolve(performance.now());
                animationDone?.();
            };
            //
            const abth = [endAnimation, { once: true, passive: true }];
            const abts = [endAnimation, { once: true, passive: true }];
            const events = addEvents(target, {
                "u2-before-hide": abth,
                "u2-before-show": abts
            });
            //
            await promise;
            endAnimation?.();
        }
    }
};
//
export const animateHide = async (target) => {
    //
    const animationDone = () => {
        if (target?.hasAttribute?.("data-hidden")) {
            target?.removeAttribute?.("data-opacity-animation");
            target?.dispatchEvent?.(new CustomEvent("u2-hidden", {
                detail: {},
                bubbles: true,
                cancelable: true
            }));
        }
    };
    //
    if (target?.hasAttribute?.("data-hidden") && target?.dispatchEvent?.(new CustomEvent("u2-before-hide", {
        detail: {},
        bubbles: true,
        cancelable: true
    }))) {
        if (!matchMedia("(prefers-reduced-motion: reduce)").matches && !target.hasAttribute("data-opacity-animation") && !target.hasAttribute("data-instant")) {
            target.setAttribute("data-opacity-animation", "");
        }
        //
        if (target.hasAttribute("data-opacity-animation")) {
            const animate = target.animate([
                {
                    easing: "linear",
                    offset: 0,
                    //
                    //"--opacity": 1,
                    //"--scale": 1,
                    //display: "revert-layer",
                    pointerEvents: "none"
                },
                {
                    easing: "linear",
                    offset: 0.99,
                    //
                    "--opacity": 0,
                    "--scale": 0.8,
                    //display: "revert-layer",
                    pointerEvents: "none"
                },
                {
                    easing: "linear",
                    offset: 1,
                    //
                    "--opacity": 0,
                    "--scale": 0.8,
                    display: "none",
                    pointerEvents: "none"
                }
            ], {
                //fill: "forwards",
                duration: 120,
                easing: "linear",
                delay: 0
                //rangeStart: "cover 0%",
                //rangeEnd: "cover 100%",
            });
            //
            let done = false;
            const endAnimation = () => {
                if (done) {
                    return;
                }
                ;
                done = true;
                events?.forEach?.((event) => event?.());
                animate.currentTime = 1;
                animate.finish();
                animationDone?.();
            };
            //
            const abth = [endAnimation, { once: true, passive: true }];
            const abts = [endAnimation, { once: true, passive: true }];
            const events = addEvents(target, {
                "u2-before-show": abts,
                //"u2-before-hide": abth
            });
            //
            await animate.finished;
            endAnimation?.();
        }
        else {
            // @ts-ignore
            const { resolve, reject, promise } = Promise.withResolvers();
            const req = requestAnimationFrame(resolve);
            //
            let done = false;
            const endAnimation = () => {
                if (done) {
                    return;
                }
                ;
                done = true;
                events?.forEach?.((event) => event?.());
                cancelAnimationFrame(req);
                resolve(performance.now());
                animationDone?.();
            };
            //
            const abth = [endAnimation, { once: true, passive: true }];
            const abts = [endAnimation, { once: true, passive: true }];
            const events = addEvents(target, { "u2-before-hide": abth, "u2-before-show": abts });
            //
            await promise;
            endAnimation?.();
        }
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQW5pbWF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQW5pbWF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0MsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxLQUFLLEVBQUUsTUFBTSxFQUFDLEVBQUU7SUFDdkMsRUFBRTtJQUNGLE1BQU0sYUFBYSxHQUFHLEdBQUUsRUFBRTtRQUN0QixJQUFJLENBQUMsTUFBTSxFQUFFLFlBQVksRUFBRSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7WUFDekMsTUFBTSxFQUFFLGVBQWUsRUFBRSxDQUFDLHdCQUF3QixDQUFDLENBQUM7WUFDcEQsTUFBTSxFQUFFLGFBQWEsRUFBRSxDQUFDLElBQUksV0FBVyxDQUFDLFdBQVcsRUFBRTtnQkFDakQsTUFBTSxFQUFFLEVBQUU7Z0JBQ1YsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsVUFBVSxFQUFFLElBQUk7YUFDbkIsQ0FBQyxDQUFDLENBQUM7UUFDUixDQUFDO0lBQ0wsQ0FBQyxDQUFBO0lBRUQsRUFBRTtJQUNGLElBQUksQ0FBQyxNQUFNLEVBQUUsWUFBWSxFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksTUFBTSxFQUFFLGFBQWEsRUFBRSxDQUFDLElBQUksV0FBVyxDQUFDLGdCQUFnQixFQUFFO1FBQ3BHLE1BQU0sRUFBRSxFQUFFO1FBQ1YsT0FBTyxFQUFFLElBQUk7UUFDYixVQUFVLEVBQUUsSUFBSTtLQUNuQixDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ0YsRUFBRTtRQUNGLElBQUksQ0FBQyxVQUFVLENBQUMsa0NBQWtDLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFD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LE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUVyRixFQUFFO1lBQ0YsTUFBTSxPQUFPLENBQUM7WUFDZCxZQUFZLEVBQUUsRUFBRSxDQUFDO1FBQ3JCLENBQUM7SUFDTCxDQUFDO0FBQ0wsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc2V0UHJvcGVydHkgfSBmcm9tIFwiLi4vbWl4aW4vU3R5bGVcIjtcbmltcG9ydCB7IGlzTW9iaWxlIH0gZnJvbSBcIi4uL2FnYXRlL0RldGVjdFwiO1xuaW1wb3J0IHsgYWRkRXZlbnRzIH0gZnJvbSBcIi4uL2FnYXRlL1V0aWxzXCI7XG5cbi8vXG5leHBvcnQgY29uc3QgYW5pbWF0ZVNob3cgPSBhc3luYyAodGFyZ2V0KT0+e1xuICAgIC8vXG4gICAgY29uc3QgYW5pbWF0aW9uRG9uZSA9ICgpPT57XG4gICAgICAgIGlmICghdGFyZ2V0Py5oYXNBdHRyaWJ1dGU/LihcImRhdGEtaGlkZGVuXCIpKSB7XG4gICAgICAgICAgICB0YXJnZXQ/LnJlbW92ZUF0dHJpYnV0ZT8uKFwiZGF0YS1vcGFjaXR5LWFuaW1hdGlvblwiKTtcbiAgICAgICAgICAgIHRhcmdldD8uZGlzcGF0Y2hFdmVudD8uKG5ldyBDdXN0b21FdmVudChcInUyLWFwcGVhclwiLCB7XG4gICAgICAgICAgICAgICAgZGV0YWlsOiB7fSxcbiAgICAgICAgICAgICAgICBidWJibGVzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGNhbmNlbGFibGU6IHRydWVcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vXG4gICAgaWYgKCF0YXJnZXQ/Lmhhc0F0dHJpYnV0ZT8uKFwiZGF0YS1oaWRkZW5cIikgJiYgdGFyZ2V0Py5kaXNwYXRjaEV2ZW50Py4obmV3IEN1c3RvbUV2ZW50KFwidTItYmVmb3JlLXNob3dcIiwge1xuICAgICAgICBkZXRhaWw6IHt9LFxuICAgICAgICBidWJibGVzOiB0cnVlLFxuICAgICAgICBjYW5jZWxhYmxlOiB0cnVlXG4gICAgfSkpKSB7XG4gICAgICAgIC8vXG4gICAgICAgIGlmICghbWF0Y2hNZWRpYShcIihwcmVmZXJzLXJlZHVjZWQtbW90aW9uOiByZWR1Y2UpXCIpLm1hdGNoZXMgJiYgIXRhcmdldC5oYXNBdHRyaWJ1dGUoXCJkYXRhLW9wYWNpdHktYW5pbWF0aW9uXCIpICYmICF0YXJnZXQuaGFzQXR0cmlidXRlKFwiZGF0YS1pbnN0YW50XCIpICYmIHRhcmdldD8uZ2V0QXR0cmlidXRlPy4oXCJkYXRhLWhpZGRlblwiKSA9PSBudWxsKSB7XG4gICAgICAgICAgICB0YXJnZXQuc2V0QXR0cmlidXRlKFwiZGF0YS1vcGFjaXR5LWFuaW1hdGlvblwiLCBcIlwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vXG4gICAgICAgIGlmICh0YXJnZXQuaGFzQXR0cmlidXRlKFwiZGF0YS1vcGFjaXR5LWFuaW1hdGlvblwiKSAmJiB0YXJnZXQ/LmdldEF0dHJpYnV0ZT8uKFwiZGF0YS1oaWRkZW5cIikgPT0gbnVsbCkge1xuICAgICAgICAgICAgY29uc3QgYW5pbWF0ZSA9IHRhcmdldC5hbmltYXRlKFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGVhc2luZzogXCJsaW5lYXJcIixcbiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0OiAwLFxuXG4gICAgICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgICAgIFwiLS1vcGFjaXR5XCI6IDAsXG4gICAgICAgICAgICAgICAgICAgIFwiLS1zY2FsZVwiOiAwLjgsXG4gICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IFwibm9uZVwiLFxuICAgICAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiBcIm5vbmVcIlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBlYXNpbmc6IFwibGluZWFyXCIsXG4gICAgICAgICAgICAgICAgICAgIG9mZnNldDogMC4wMSxcblxuICAgICAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgICAgICBcIi0tb3BhY2l0eVwiOiAwLFxuICAgICAgICAgICAgICAgICAgICBcIi0tc2NhbGVcIjogMC44LFxuICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBcIm5vbmVcIixcbiAgICAgICAgICAgICAgICAgICAgcG9pbnRlckV2ZW50czogXCJub25lXCJcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgZWFzaW5nOiBcImxpbmVhclwiLFxuICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IDEsXG5cbiAgICAgICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICAgICAgXCItLW9wYWNpdHlcIjogMSxcbiAgICAgICAgICAgICAgICAgICAgXCItLXNjYWxlXCI6IDEsXG4gICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IFwicmV2ZXJ0LWxheWVyXCIsXG4gICAgICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6IFwicmV2ZXJ0LWxheWVyXCJcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdLCB7XG4gICAgICAgICAgICAgICAgLy9maWxsOiBcImZvcndhcmRzXCIsXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IGlzTW9iaWxlKCkgPyAxMDAgOiA4MCxcbiAgICAgICAgICAgICAgICBlYXNpbmc6IFwibGluZWFyXCIsXG4gICAgICAgICAgICAgICAgZGVsYXk6IDBcbiAgICAgICAgICAgICAgICAvL3JhbmdlU3RhcnQ6IFwiY292ZXIgMCVcIixcbiAgICAgICAgICAgICAgICAvL3JhbmdlRW5kOiBcImNvdmVyIDEwMCVcIixcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgbGV0IGRvbmUgPSBmYWxzZTtcbiAgICAgICAgICAgIGNvbnN0IGVuZEFuaW1hdGlvbiA9ICgpPT4ge1xuICAgICAgICAgICAgICAgIGlmIChkb25lKSB7IHJldHVybjsgfTsgZG9uZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgZXZlbnRzPy5mb3JFYWNoPy4oKGV2ZW50KT0+ZXZlbnQ/LigpKTtcbiAgICAgICAgICAgICAgICBhbmltYXRlLmN1cnJlbnRUaW1lID0gMTtcbiAgICAgICAgICAgICAgICBhbmltYXRlLmZpbmlzaCgpO1xuICAgICAgICAgICAgICAgIGFuaW1hdGlvbkRvbmU/LigpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIGNvbnN0IGFidGggPSBbZW5kQW5pbWF0aW9uLCB7b25jZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZX1dO1xuICAgICAgICAgICAgY29uc3QgYWJ0cyA9IFtlbmRBbmltYXRpb24sIHtvbmNlOiB0cnVlLCBwYXNzaXZlOiB0cnVlfV07XG5cbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICBjb25zdCBldmVudHMgPSBhZGRFdmVudHModGFyZ2V0LCB7XG4gICAgICAgICAgICAgICAgXCJ1Mi1iZWZvcmUtaGlkZVwiOiBhYnRoLFxuICAgICAgICAgICAgICAgIFwidTItYmVmb3JlLXNob3dcIjogYWJ0c1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICBhd2FpdCBhbmltYXRlLmZpbmlzaGVkO1xuICAgICAgICAgICAgZW5kQW5pbWF0aW9uPy4oKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGNvbnN0IHtyZXNvbHZlLCByZWplY3QsIHByb21pc2V9ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7XG4gICAgICAgICAgICBjb25zdCByZXEgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUocmVzb2x2ZSk7XG5cbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICBsZXQgZG9uZSA9IGZhbHNlO1xuICAgICAgICAgICAgY29uc3QgZW5kQW5pbWF0aW9uID0gKCk9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGRvbmUpIHsgcmV0dXJuOyB9OyBkb25lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBldmVudHM/LmZvckVhY2g/LigoZXZlbnQpPT5ldmVudD8uKCkpO1xuICAgICAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHJlcSk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShwZXJmb3JtYW5jZS5ub3coKSk7XG4gICAgICAgICAgICAgICAgYW5pbWF0aW9uRG9uZT8uKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICBjb25zdCBhYnRoID0gW2VuZEFuaW1hdGlvbiwge29uY2U6IHRydWUsIHBhc3NpdmU6IHRydWV9XTtcbiAgICAgICAgICAgIGNvbnN0IGFidHMgPSBbZW5kQW5pbWF0aW9uLCB7b25jZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZX1dO1xuICAgICAgICAgICAgY29uc3QgZXZlbnRzID0gYWRkRXZlbnRzKHRhcmdldCwge1xuICAgICAgICAgICAgICAgIFwidTItYmVmb3JlLWhpZGVcIjogYWJ0aCxcbiAgICAgICAgICAgICAgICBcInUyLWJlZm9yZS1zaG93XCI6IGFidHNcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgYXdhaXQgcHJvbWlzZTtcbiAgICAgICAgICAgIGVuZEFuaW1hdGlvbj8uKCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cblxuLy9cbmV4cG9ydCBjb25zdCBhbmltYXRlSGlkZSA9IGFzeW5jICh0YXJnZXQpPT57XG4gICAgLy9cbiAgICBjb25zdCBhbmltYXRpb25Eb25lID0gKCk9PntcbiAgICAgICAgaWYgKHRhcmdldD8uaGFzQXR0cmlidXRlPy4oXCJkYXRhLWhpZGRlblwiKSkge1xuICAgICAgICAgICAgdGFyZ2V0Py5yZW1vdmVBdHRyaWJ1dGU/LihcImRhdGEtb3BhY2l0eS1hbmltYXRpb25cIik7XG4gICAgICAgICAgICB0YXJnZXQ/LmRpc3BhdGNoRXZlbnQ/LihuZXcgQ3VzdG9tRXZlbnQoXCJ1Mi1oaWRkZW5cIiwge1xuICAgICAgICAgICAgICAgIGRldGFpbDoge30sXG4gICAgICAgICAgICAgICAgYnViYmxlczogdHJ1ZSxcbiAgICAgICAgICAgICAgICBjYW5jZWxhYmxlOiB0cnVlXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvL1xuICAgIGlmICh0YXJnZXQ/Lmhhc0F0dHJpYnV0ZT8uKFwiZGF0YS1oaWRkZW5cIikgJiYgdGFyZ2V0Py5kaXNwYXRjaEV2ZW50Py4obmV3IEN1c3RvbUV2ZW50KFwidTItYmVmb3JlLWhpZGVcIiwge1xuICAgICAgICBkZXRhaWw6IHt9LFxuICAgICAgICBidWJibGVzOiB0cnVlLFxuICAgICAgICBjYW5jZWxhYmxlOiB0cnVlXG4gICAgfSkpKSB7XG4gICAgICAgIGlmICghbWF0Y2hNZWRpYShcIihwcmVmZXJzLXJlZHVjZWQtbW90aW9uOiByZWR1Y2UpXCIpLm1hdGNoZXMgJiYgIXRhcmdldC5oYXNBdHRyaWJ1dGUoXCJkYXRhLW9wYWNpdHktYW5pbWF0aW9uXCIpICYmICF0YXJnZXQuaGFzQXR0cmlidXRlKFwiZGF0YS1pbnN0YW50XCIpKSB7XG4gICAgICAgICAgICB0YXJnZXQuc2V0QXR0cmlidXRlKFwiZGF0YS1vcGFjaXR5LWFuaW1hdGlvblwiLCBcIlwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vXG4gICAgICAgIGlmICh0YXJnZXQuaGFzQXR0cmlidXRlKFwiZGF0YS1vcGFjaXR5LWFuaW1hdGlvblwiKSkge1xuICAgICAgICAgICAgY29uc3QgYW5pbWF0ZSA9IHRhcmdldC5hbmltYXRlKFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGVhc2luZzogXCJsaW5lYXJcIixcbiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0OiAwLFxuXG4gICAgICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgICAgIC8vXCItLW9wYWNpdHlcIjogMSxcbiAgICAgICAgICAgICAgICAgICAgLy9cIi0tc2NhbGVcIjogMSxcbiAgICAgICAgICAgICAgICAgICAgLy9kaXNwbGF5OiBcInJldmVydC1sYXllclwiLFxuICAgICAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiBcIm5vbmVcIlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBlYXNpbmc6IFwibGluZWFyXCIsXG4gICAgICAgICAgICAgICAgICAgIG9mZnNldDogMC45OSxcblxuICAgICAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgICAgICBcIi0tb3BhY2l0eVwiOiAwLFxuICAgICAgICAgICAgICAgICAgICBcIi0tc2NhbGVcIjogMC44LFxuICAgICAgICAgICAgICAgICAgICAvL2Rpc3BsYXk6IFwicmV2ZXJ0LWxheWVyXCIsXG4gICAgICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6IFwibm9uZVwiXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGVhc2luZzogXCJsaW5lYXJcIixcbiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0OiAxLFxuXG4gICAgICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgICAgIFwiLS1vcGFjaXR5XCI6IDAsXG4gICAgICAgICAgICAgICAgICAgIFwiLS1zY2FsZVwiOiAwLjgsXG4gICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IFwibm9uZVwiLFxuICAgICAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiBcIm5vbmVcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF0sICB7XG4gICAgICAgICAgICAgICAgLy9maWxsOiBcImZvcndhcmRzXCIsXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IDEyMCxcbiAgICAgICAgICAgICAgICBlYXNpbmc6IFwibGluZWFyXCIsXG4gICAgICAgICAgICAgICAgZGVsYXk6IDBcbiAgICAgICAgICAgICAgICAvL3JhbmdlU3RhcnQ6IFwiY292ZXIgMCVcIixcbiAgICAgICAgICAgICAgICAvL3JhbmdlRW5kOiBcImNvdmVyIDEwMCVcIixcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgbGV0IGRvbmUgPSBmYWxzZTtcbiAgICAgICAgICAgIGNvbnN0IGVuZEFuaW1hdGlvbiA9ICgpPT4ge1xuICAgICAgICAgICAgICAgIGlmIChkb25lKSB7IHJldHVybjsgfTsgZG9uZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgZXZlbnRzPy5mb3JFYWNoPy4oKGV2ZW50KT0+ZXZlbnQ/LigpKTtcbiAgICAgICAgICAgICAgICBhbmltYXRlLmN1cnJlbnRUaW1lID0gMTtcbiAgICAgICAgICAgICAgICBhbmltYXRlLmZpbmlzaCgpO1xuICAgICAgICAgICAgICAgIGFuaW1hdGlvbkRvbmU/LigpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIGNvbnN0IGFidGggPSBbZW5kQW5pbWF0aW9uLCB7b25jZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZX1dO1xuICAgICAgICAgICAgY29uc3QgYWJ0cyA9IFtlbmRBbmltYXRpb24sIHtvbmNlOiB0cnVlLCBwYXNzaXZlOiB0cnVlfV07XG4gICAgICAgICAgICBjb25zdCBldmVudHMgPSBhZGRFdmVudHModGFyZ2V0LCB7XG4gICAgICAgICAgICAgICAgXCJ1Mi1iZWZvcmUtc2hvd1wiOiBhYnRzLFxuICAgICAgICAgICAgICAgIC8vXCJ1Mi1iZWZvcmUtaGlkZVwiOiBhYnRoXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIGF3YWl0IGFuaW1hdGUuZmluaXNoZWQ7XG4gICAgICAgICAgICBlbmRBbmltYXRpb24/LigpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgY29uc3Qge3Jlc29sdmUsIHJlamVjdCwgcHJvbWlzZX0gPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTtcbiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShyZXNvbHZlKTtcblxuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIGxldCBkb25lID0gZmFsc2U7XG4gICAgICAgICAgICBjb25zdCBlbmRBbmltYXRpb24gPSAoKT0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZG9uZSkgeyByZXR1cm47IH07IGRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGV2ZW50cz8uZm9yRWFjaD8uKChldmVudCk9PmV2ZW50Py4oKSk7XG4gICAgICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmVxKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHBlcmZvcm1hbmNlLm5vdygpKTtcbiAgICAgICAgICAgICAgICBhbmltYXRpb25Eb25lPy4oKTtcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICBjb25zdCBhYnRoID0gW2VuZEFuaW1hdGlvbiwge29uY2U6IHRydWUsIHBhc3NpdmU6IHRydWV9XTtcbiAgICAgICAgICAgIGNvbnN0IGFidHMgPSBbZW5kQW5pbWF0aW9uLCB7b25jZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZX1dO1xuICAgICAgICAgICAgY29uc3QgZXZlbnRzID0gYWRkRXZlbnRzKHRhcmdldCwgeyBcInUyLWJlZm9yZS1oaWRlXCI6IGFidGgsIFwidTItYmVmb3JlLXNob3dcIjogYWJ0cyB9KTtcblxuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIGF3YWl0IHByb21pc2U7XG4gICAgICAgICAgICBlbmRBbmltYXRpb24/LigpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19